<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Combined</title>
</head>


<body>
<div class="head">
<h1>Theory Combined</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Combined
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Exchange.html">Exchange</a>
    <a href="Propagate.html">Propagate</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"comp_fun_commute <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_fun_commute.fold_insert<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Could-result-in relation›</span></span>

<span class="keyword1"><span class="command">context</span></span> dataflow_topology <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cri_less_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span>_"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cri_less_eq</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc2</span><span class="main">,</span><span class="bound">t2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> <span class="free">results_in</span> <span class="bound">t1</span> <span class="bound">s</span> <span class="main">≤</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cri_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span>_"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cri_less</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cri_asym1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">y</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">t1</span> <span class="skolem">loc2</span> <span class="skolem">t2</span>
  <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">y</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc2</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc1</span> <span class="main">≠</span> <span class="skolem">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cri_less_def cri_less_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
      <span class="main">(</span><span class="operator">metis</span> add.right_neutral order.antisym order.trans le_plus<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> as <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t1</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_less_def cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">path1</span></span> <span class="keyword2"><span class="keyword">where</span></span> path1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">path1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> flow.sum_path_weights <span class="skolem">path1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">path1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as1 flow.path_weight_conv_path flow.path0E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> as <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc2</span> <span class="skolem">loc1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t2</span> <span class="skolem">s2</span> <span class="main">≤</span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_less_def cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">path2</span></span> <span class="keyword2"><span class="keyword">where</span></span> path2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc2</span> <span class="skolem">loc1</span> <span class="skolem">path2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> flow.sum_path_weights <span class="skolem">path2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">path2</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as1 flow.path_weight_conv_path flow.path0E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> path1 <span class="keyword1"><span class="command">have</span></span> path_total<span class="main">:</span> <span class="quoted"><span class="quoted">"flow.path <span class="skolem">loc1</span> <span class="skolem">loc1</span> <span class="main">(</span><span class="skolem">path1</span><span class="main">@</span><span class="skolem">path2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow.path_trans path2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="keyword2"><span class="keyword">where</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">=</span> flow.sum_path_weights <span class="main">(</span><span class="skolem">path1</span><span class="main">@</span><span class="skolem">path2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s3_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">=</span> followed_by <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> path1 path2 flow.sum_weights_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t1</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">t1</span> <span class="skolem">s3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s3_sum s1<span class="main">(</span>2<span class="main">)</span> s2<span class="main">(</span>2<span class="main">)</span> followed_by_summary
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans less_le_not_le results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> path_total no_zero_cycle s3 path1<span class="main">(</span>3<span class="main">)</span> path2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cri_asym2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri_less_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> cri<span class="main">:</span> order <span class="quoted">cri_less_eq</span> <span class="quoted">cri_less</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cri_asym1 cri_asym2 cri_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">unfolding</span></span> cri_less_eq_def
    <span class="keyword1"><span class="command">using</span></span> flow.path_weight_refl results_in_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> x y z <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">aa</span> <span class="skolem">ba</span> <span class="skolem">ab</span> <span class="skolem">bb</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aa</span><span class="main">,</span> <span class="skolem">ba</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ab</span><span class="main">,</span> <span class="skolem">bb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">a</span> <span class="skolem">aa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="skolem">ba</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> as<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">aa</span> <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">ba</span> <span class="skolem">s2</span> <span class="main">≤</span> <span class="skolem">bb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="keyword2"><span class="keyword">where</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">a</span> <span class="skolem">ab</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s3</span> <span class="main">≤</span> followed_by <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flow.path_weight_elem_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> s1 s2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s3</span> <span class="main">≤</span> <span class="skolem">bb</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">b</span> <span class="skolem">s1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">ba</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> followed_by_summary order_trans s2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> as s3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cri_less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">using</span></span> cri_asym1 cri_asym2 cri_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_cri<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">&lt;<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_acyclic_wf<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cri.acyclicI_order<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> acyclic_converse<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Configuration›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">::</span><span class="quoted">finite</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span><span class="quoted">order</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">=</span>
  exchange_config <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span><span class="main">)</span> Exchange.configuration"</span></span>
  prop_config <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Propagate.configuration"</span></span>
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* True = initialization finished *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">context</span></span> dataflow_topology <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_cm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_cm</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">c'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹the_cm is not commutative in general, only if the necessary conditions hold. It can be converted
to apply_cm for which we prove comp_fun_commute.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_cm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_cm</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">new_pointstamps</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span>
                <span class="main">(</span><span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="keyword1">then</span> update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
                               <span class="keyword1">else</span> c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⦇</span> c_pts <span class="main">:=</span> <span class="bound">new_pointstamps</span> <span class="main">⦈</span>
          <span class="main">⦇</span> c_work <span class="main">:=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span> <span class="main">+</span> frontier_changes <span class="main">(</span><span class="bound">new_pointstamps</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cm_all'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_all'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">=</span>
      Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cm_all</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_all</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">=</span>
      Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> the_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">(</span>set_zmset <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">propagate_all</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">=</span> while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> <span class="main">(</span>c_work <span class="bound">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>
                                            <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Initial state and state transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InitConfig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InitConfig</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> False<span class="main">)</span>
    <span class="main">∧</span> cri.init_config <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
       <span class="main">=</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">w</span><span class="main">.</span> init_config <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextPerformOp'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPerformOp'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">=</span> <span class="main">(</span>
     cri.next_performop' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span>
   <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextPerformOp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPerformOp</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">.</span> NextPerformOp' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextRecvCap'</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvCap'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
     cri.next_recvcap' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
   <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextRecvCap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvCap</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> NextRecvCap' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextSendUpd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextSendUpd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span> <span class="main">(</span>
    cri.next_sendupd' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span>
  <span class="main">∧</span> unchanged prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
  <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextSendUpd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextSendUpd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> NextSendUpd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">tt</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextRecvUpd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvUpd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>
     init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="comment1">― ‹Once init is set we are guaranteed that the CM transitions' premises are satisfied›</span>
   <span class="main">∧</span> cri.next_recvupd' <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
   <span class="main">∧</span> unchanged init <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> prop_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p'</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
           <span class="keyword1">then</span> cm_all <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">else</span> prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextRecvUpd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextRecvUpd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> NextRecvUpd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NextPropagate'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration
                              <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPropagate'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
     unchanged exchange_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>
   <span class="main">∧</span>  init <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> True<span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> Some <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
           <span class="keyword1">then</span> propagate_all <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span>
           <span class="keyword1">else</span> Some <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NextPropagate</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NextPropagate</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> NextPropagate' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">Next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>NextPerformOp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextSendUpd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextRecvUpd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextPropagate <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> NextRecvCap <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">Next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FullSpec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FullSpec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>holds InitConfig <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw Next <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextPerformOpD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPerformOp' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_performop' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextPerformOp'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> NextSendUpdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextSendUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_sendupd' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextSendUpd'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"init <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"cri.next_recvupd' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> prop_config <span class="free">c1</span> <span class="bound">p'</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">q</span>
          <span class="keyword1">then</span> cm_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextRecvUpd'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> NextPropagateD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"unchanged exchange_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"init <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>init <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> True<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span>
          <span class="keyword1">then</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span>
          <span class="keyword1">else</span> Some <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextPropagate'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvCapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextRecvCap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cri.next_recvcap' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged prop_config <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"unchanged init <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> NextRecvCap'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Auxiliary lemmas for CM conversion›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_cm_is_cm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="free">c</span> <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def apply_cm_def
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_zmultiset_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_zmultiset <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t'</span> <span class="free">n'</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> update_zmultiset <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">t'</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_cm_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_cm <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc'</span> <span class="free">t'</span> <span class="free">n'</span> <span class="main">=</span> apply_cm <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc'</span> <span class="free">t'</span> <span class="free">n'</span><span class="main">)</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apply_cm_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_zmultiset_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_fun_commute_apply_cm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">(</span><span class="free">f</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_zmultiset_commute comp_fun_commute_def o_def apply_cm_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_cm_imp_conds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_cm_eq_apply_cm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_cm_imp_conds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> the_cm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_change_multiplicity'_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cond<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> apply_cm_def next_change_multiplicity'_def
    <span class="keyword1"><span class="command">using</span></span> cond <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_cm_preserves_cond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>apply_cm <span class="free">c0</span> <span class="free">loc'</span> <span class="free">t''</span> <span class="free">n</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cm_all_eq_cm_all'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set_zmset <span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"cm_all <span class="free">c0</span> <span class="free">Δ</span> <span class="main">=</span> cm_all' <span class="free">c0</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cm_all_def cm_all'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fold_closed_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">loc</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">∈</span></span>set_zmset <span class="free"><span class="free">Δ</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="keyword1"><span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span></span> frontier <span class="main"><span class="main">(</span></span>c_imp <span class="bound"><span class="bound">c</span></span> <span class="bound"><span class="bound">loc</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">t'</span></span> <span class="main"><span class="main">≤</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a Δ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> the_cm_eq_apply_cm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ex1_implies_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_change_multiplicity'_unique<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a Δ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> apply_cm_preserves_cond<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cm_eq_the_cm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c</span> <span class="free">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> next_change_multiplicity'_unique<span class="main">[</span><span class="operator">OF</span> cond<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms the_cm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_ps_apply_cm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">loc'</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc'</span><span class="main">)</span> <span class="free">t'</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">loc</span> <span class="main">=</span> <span class="free">loc'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def zcount_update_zmultiset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_pointstamps_update<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="free">c</span><span class="main">⦇</span>c_pts<span class="main">:=</span><span class="free">M</span><span class="main">⦈</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> zcount <span class="main">(</span><span class="free">M</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">loc1</span> <span class="main">≠</span> <span class="free">loc2</span> <span class="main">∨</span> <span class="free">t1</span> <span class="main">≠</span> <span class="free">t2</span> <span class="main">⟶</span>
    zcount <span class="main">(</span>c_pts <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc2</span> <span class="free">t2</span> <span class="main">(</span>zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc2</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span>
    zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> zcount_update_zmultiset
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_nop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ'</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>
                          <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
  <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_set_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fold_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ'</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">loc'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> nonmember<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_s<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> commute<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_fun_commute <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_fun_commute_def comp_def apply_cm_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> finite_s <span class="keyword1"><span class="command">have</span></span> step1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_fun_commute.fold_insert insert.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonmember <span class="keyword1"><span class="command">have</span></span> step2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="var">?f</span> <span class="skolem">x</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_pair
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv nop<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step1 <span class="keyword2"><span class="keyword">and</span></span> x_pair <span class="keyword1"><span class="command">have</span></span> final<span class="main">:</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="skolem">F</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ2</span> <span class="main">=</span> filter_zmset <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">≠</span><span class="skolem">x</span><span class="main">)</span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> set_zmset <span class="skolem">Δ2</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> Δ2 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nonmember <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Δ2 ** <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">y</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">Δ2</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> count_filter_zmset zcount_ne_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> *** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> set_zmset <span class="skolem">Δ</span> <span class="main">=</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span>set_zmset <span class="skolem">Δ2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_zmset <span class="skolem">Δ</span> <span class="main">=</span> set_zmset <span class="skolem">Δ2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> insert<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> *  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Diff_insert Diff_insert2 Diff_insert_absorb Un_empty_right Un_insert_right<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> final insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_pointstamps_cm_all'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
 <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> apply_cm <span class="bound">c</span> <span class="bound">loc'</span> <span class="bound">t'</span> <span class="main">(</span>zcount <span class="free">Δ</span> <span class="main">(</span><span class="bound">loc'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="free">Δ</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> case_nonmember<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_zmsetΔ<span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> set_zmset <span class="free">Δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zcount_eq_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
             <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_zmsetΔ<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_nop<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> case_nonmember <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> case_member<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fold_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">)</span>
             <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">Δ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> case_member zcount_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> comp_fun_commute_apply_cm
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> comp_fun_commute.fold_rec<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
          <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_nop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_pts <span class="main">(</span>Finite_Set.fold <span class="var">?f</span> <span class="free">c</span> <span class="main">(</span>set_zmset <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>
             <span class="main">=</span> zcount <span class="main">(</span>c_pts <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="free">loc</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_nop fold_rec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_ps_apply_cm<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_ps_apply_cm cm_all'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implications_apply_cm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="main">(</span>apply_cm <span class="free">c</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> c_imp <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_cm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> implications_cm_all<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"c_imp <span class="main">(</span>cm_all' <span class="free">c</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> c_imp <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fold_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_cm_inv_cm_all'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>cm_all' <span class="free">c0</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond_invar</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?invar</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="var">?cond_invar</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">c</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cm_all'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fold_invar<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?invar</span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> apply_cm_is_cm<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_cm_inv_cm_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">Δ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>cm_all <span class="free">c0</span> <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cm_all_eq_cm_all'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_cm_inv_cm_all'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Finds a minimal timestamp - location pair in a non-empty zmset (e.g. in c_work) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> obtain_min_worklist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">loc'</span><span class="main">::</span><span class="main">(</span><span class="main">_</span> <span class="main">::</span> finite<span class="main">)</span><span class="main">)</span><span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> zmultiset<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">loc</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="free">loc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> minimal_antichain <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_zcount_in_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite  <span class="main">(</span><span class="main">⋃</span><span class="bound">loc'</span><span class="main">.</span> set_zmset <span class="main">(</span><span class="free">a</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f
    <span class="keyword1"><span class="command">using</span></span> minimal_antichain_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="skolem">f</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_min_if_finite f minimal_antichain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> thesis1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> <span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">loc</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">a</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> propagate_pointstamps_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c</span> <span class="free">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"c_pts <span class="free">c</span> <span class="main">=</span> c_pts <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc't<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="skolem">loc'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtain_min_worklist<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"c_work <span class="free"><span class="free">c</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">loc</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?imps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> c_imp <span class="free">c</span> <span class="bound">locX</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">#}</span>
                                     <span class="keyword1">else</span> c_imp <span class="free">c</span> <span class="bound">locX</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="skolem">t</span><span class="main">#}</span>
                    <span class="keyword1">else</span> c_work <span class="free">c</span> <span class="bound">locX</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span><span class="var">?imps</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc'</span> <span class="bound">locX</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="var">?imps</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?wl</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> loc't assms <span class="keyword1"><span class="command">have</span></span> propagate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="skolem">loc</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c</span> <span class="skolem">c'</span> <span class="skolem">loc</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_pts <span class="free">c</span> <span class="main">=</span> c_pts <span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_propagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> propagate <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> verit_sko_ex'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> propagate_all_imp_InvGlobPointstampsEq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">c1</span> <span class="main">=</span> propagate_all <span class="free">c0</span> <span class="main">⟹</span> c_pts <span class="free">c0</span> <span class="main">=</span> c_pts <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> propagate_all_def
  <span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> c_pts <span class="free">c0</span> <span class="main">=</span> c_pts <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
    propagate_pointstamps_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_next_propagate'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c</span> <span class="free">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free">c</span> <span class="bound">c'</span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc't<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="skolem">loc'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> obtain_min_worklist<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?imps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> c_imp <span class="free">c</span> <span class="bound">locX</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">#}</span>
                                     <span class="keyword1">else</span> c_imp <span class="free">c</span> <span class="bound">locX</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">locX</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">locX</span> <span class="main">=</span> <span class="skolem">loc'</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free">c</span> <span class="bound">locX</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="skolem">t</span><span class="main">#}</span>
                    <span class="keyword1">else</span> c_work <span class="free">c</span> <span class="bound">locX</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span><span class="var">?imps</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc'</span> <span class="bound">locX</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="var">?imps</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?wl</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> loc't assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Propagate.configuration.equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_propagate_inv_propagate_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"propagate_all <span class="free">c0</span> <span class="main">=</span> Some <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propagate_all_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c loc
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> exists_next_propagate'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> verit_sko_ex'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Exchange is a subsystem of Tracker›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Steps in the Tracker are valid steps in the Exchange protocol.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> next_imp_exchange_next<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> cri.next' <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span> <span class="main">(</span>exchange_config <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Next'_def cri.next'_def NextPerformOp'_def NextRecvUpd'_def NextSendUpd'_def NextPropagate'_def NextRecvCap'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_next_imp_exchange_next<span class="main">:</span> <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span> <span class="main">⟹</span> alw cri.next <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD next_imp_exchange_next<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any Tracker trace is a valid Exchange trace›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> spec_imp_exchange_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> cri.spec <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cri.spec_def FullSpec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InitConfig_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_next_imp_exchange_next<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_exchange_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> cri.spec <span class="bound">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>exchange_config <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> spec_imp_exchange_spec<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_holds_smap_conv_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Lifted Exchange invariants›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span>
  exch_alw_InvCapsNonneg                 <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvCapsNonneg<span class="main">,</span> <span class="operator">unfolded</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvRecordCount                <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvRecordCount<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvRecordsNonneg              <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvRecordsNonneg<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobVacantImpRecordsVacant <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobVacantImpRecordsVacant<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobNonposImpRecordsNonpos <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobNonposImpRecordsNonpos<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvJustifiedGII               <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvJustifiedGII<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvJustifiedII                <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvJustifiedII<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvGlobNonposEqVacant         <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvGlobNonposEqVacant<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvMsgInGlob                  <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvMsgInGlob<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  exch_alw_InvTempJustified              <span class="main">=</span> lift_exchange_invariant<span class="main">[</span><span class="operator">OF</span> cri.alw_InvTempJustified<span class="main">,</span> <span class="operator">simplified</span> atomize_imp<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">folded</span> atomize_imp<span class="main">]</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="comment1">(* First variant of global safe *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_combined</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_combined</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p</span><span class="main">.</span>
        zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span>
         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Second variant of global safe *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_combined2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_combined2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span> <span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span>
        zcount <span class="main">(</span>c_caps <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p1</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p2</span>
         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p2</span><span class="main">)</span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobPointstampsEq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobPointstampsEq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
                 <span class="main">=</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">loc</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_combined_implies_safe_combined2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvCapsNonneg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"safe_combined <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe_combined2 <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_combined2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 loc2 t s p1 p2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> safe_combined_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri.records_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_pos_nonneg<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri.InvCapsNonneg_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Propagate is a subsystem of Tracker›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹CM conditions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvMsgCMConditions</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvMsgCMConditions</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span>
    init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">⟶</span> c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Pointstamps in incoming messages all satisfy the CM premise, which is required during NextRecvUpd' steps.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> msg_is_cm_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">::</span>order<span class="main">,</span> <span class="tfree">'loc</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"c_msg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">loc</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>hd <span class="main">(</span>c_msg <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Propagate safety and InvGlobPointstampsEq›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In order to be able to use the msg_is_cm_safe lemma at all times and show that Propagate is a
subsystem we need to prove that the specification implies Propagate's safe and the
InvGlobPointstampsEq. Both of these depend on the CM conditions being satisfied during the
NextRecvUpd' step and the safety proof additionally depends on other Propagate invariants, which
means that we need to prove all of these jointly.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prop_invs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prop_invs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> inv_implications_nonneg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> inv_imps_work_sum <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prop_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prop_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> impl_safe <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> safe <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_init_imp_prop_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_init_imp_prop_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> init <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">⟶</span> prop_safe <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpd'_preserves_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> safes<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prop_safe <span class="skolem">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">⟹</span> prop_safe <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span>
      cm_preserves_safe
      cm_preserves_impl_safe
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prop_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>
      lift_cm_inv_cm_all<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> cm_conds<span class="main">,</span> <span class="operator">of</span> <span class="quoted">prop_safe</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      safes
      NextRecvUpdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpd'_preserves_InvGlobPointstampsEq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>
      assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      cm_conds
    <span class="keyword1"><span class="command">unfolding</span></span> NextRecvUpd'_def cri.next_recvupd'_def Let_def InvGlobPointstampsEq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_pointstamps_cm_all' cm_all_eq_cm_all'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Whenever some worker p propagates it ends up in a Propagate-safe state›</span>
<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_causes_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wl<span class="main">:</span> <span class="quoted"><span class="quoted">"c_work <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">unfolding</span></span> propagate_all_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> while_option_stop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> wl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> impl_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> wl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹NextPropagate' preserves Propagate-safe at all workers›</span>
<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_preserves_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NextPropagate'_causes_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_preserves_impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NextPropagate'_causes_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpd'_preserves_inv_init_imp_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextRecvUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> NextRecvUpd'_preserves_prop_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpd'_preserves_prop_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> inv_init_imp_prop_safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> recvupd_change <span class="main">=</span> cri.next_recvupdD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> cm_conds <span class="main">=</span> msg_is_cm_safe<span class="main">[</span><span class="operator">OF</span> safe assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> recvupd_change<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prop_invs <span class="skolem">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">⟹</span> prop_invs <span class="skolem">c1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c0</span> <span class="skolem">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span>
      cm_preserves_inv_imps_work_sum
      cm_preserves_inv_implications_nonneg
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span>
          lift_cm_inv_cm_all<span class="main">[</span><span class="operator">rotated</span><span class="main">,</span> <span class="operator">OF</span> cm_conds<span class="main">,</span> <span class="operator">of</span> <span class="quoted">prop_invs</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          invs
          NextRecvUpdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_preserves_prop_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span>
      assms<span class="main">(</span>1<span class="main">)</span>
      lift_propagate_inv_propagate_all<span class="main">[</span>
        <span class="operator">of</span> <span class="quoted">prop_invs</span><span class="main">,</span>
        <span class="operator">rotated</span> 2<span class="main">,</span>
        <span class="operator">OF</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iiws_imp_iipwn p_preserves_inv_implications_nonneg p_preserves_inv_imps_work_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_preserves_inv_init_imp_prop_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_prop_invs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_causes_safe<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagateD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Next'_preserves_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c0</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextPerformOpD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextSendUpdD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpd'_preserves_inv_init_imp_prop_safe<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_inv_init_imp_prop_safe assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextRecvCapD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPerformOpD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextSendUpdD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> NextRecvUpd'_preserves_prop_invs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextPropagate'_preserves_prop_invs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inv_init_imp_prop_safe_def
      <span class="keyword1"><span class="command">using</span></span> NextRecvCapD<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Next'_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextPerformOpD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> cri.next_performopD<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextSendUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> cri.next_sendupdD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> NextRecvUpdD<span class="main">(</span>1<span class="main">)</span> NextRecvUpd'_preserves_InvGlobPointstampsEq assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> inv_init_imp_prop_safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> NextPropagate'_def InvGlobPointstampsEq_def
      <span class="keyword1"><span class="command">using</span></span> propagate_all_imp_InvGlobPointstampsEq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def NextRecvCapD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> NextRecvCapD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cri.next_recvcapD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_imp_InvGlobPointstampsEq<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> InvGlobPointstampsEq <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitConfig_def cri.init_config_def InvGlobPointstampsEq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_imp_inv_init_imp_prop_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> inv_init_imp_prop_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_init_imp_prop_safe_def InitConfig_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_imp_prop_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"InitConfig <span class="free">c</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free">c</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitConfig_def init_imp_inv_implications_nonneg init_imp_inv_imps_work_sum<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">all_invs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_invs</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> InvGlobPointstampsEq <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> inv_init_imp_prop_safe <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_Next'_alw_invs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds all_invs <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds all_invs<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_holds2 Next'_preserves_invs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> alwD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds all_invs<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FullSpec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> init_imp_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> init_imp_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_imp_prop_invs<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_Next'_alw_invs alw_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobPointstampsEq<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobPointstampsEq<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_invs alw_mono holds_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_inv_init_imp_prop_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_init_imp_prop_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_invs alw_mono holds_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_holds_conv_shd<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_prop_invs<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="bound">c</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"holds all_invs"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_invs <span class="main">(</span>prop_config <span class="bound">c</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alw_invs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nrec_pts_delayed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvGlobNonposImpRecordsNonpos <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">x</span> <span class="main">∧</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> cri.nonpos_upto <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cri.InvGlobNonposImpRecordsNonpos_def cri.nonpos_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_not_less cri.order.order_iff_strict<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri.nonpos_upto_def not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> help_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc0</span><span class="main">)</span> <span class="free">t0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">loc0</span><span class="main">,</span> <span class="free">t0</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">loc1</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t2</span><span class="main">.</span> <span class="main">(</span><span class="bound">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s2</span>
                <span class="main">∧</span> <span class="bound">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc0</span> <span class="free">loc1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s1</span> <span class="main">≤</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s1<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s_full</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_full<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s_full</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc0</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_full</span> <span class="main">≤</span> followed_by <span class="skolem">s1</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow.path_weight_elem_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s_full<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s_full</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> t2<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> s_full<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t0</span> <span class="skolem">s1</span><span class="main">)</span> <span class="free">s2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> followed_by_summary order_trans results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Lift an invariant's preservation proof over next_propagate' to NextPropagate' transitions›</span>
<span class="keyword1"><span class="command">lemma</span></span> lift_prop_inv_NextPropagate'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate' <span class="bound">c0</span> <span class="bound">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⟹</span> NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> pc0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c0</span> <span class="main">⟹</span> next_propagate <span class="bound">c0</span> <span class="bound">c1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_propagate <span class="bound">c</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> np <span class="keyword1"><span class="command">have</span></span> pc1<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> propagate_all <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextPropagate'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?b</span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"prop_config <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> n_p<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> verit_sko_ex<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exists_next_propagate'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">using</span></span> pc1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> propagate_all_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pc0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> np pc0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NextPropagate'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">p'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Propagate is a subsystem›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> NextRecvUpd'_next'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"NextRecvUpd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cm_all_eq_cm_all'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> cri.next_recvupdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc t loc' t'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_cm_inv_cm_all'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cri.InvMsgInGlob_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> cri.next_recvupdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc t loc' t'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobPointstampsEq_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cri_less_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> NextPropagate'_next'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"NextPropagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lift_propagate_inv_propagate_all<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"prop_config <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NextPropagateD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms next'_def option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tranclp.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_imp_propagate_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"cri.InvMsgInGlob <span class="main">(</span>exchange_config <span class="free">c0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span>prop_config <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>prop_config <span class="free">c1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Next'_def NextPerformOp'_def NextSendUpd'_def NextRecvCap'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' q
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_init_imp_prop_safe_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> NextRecvUpdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> NextRecvUpd'_next'<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2-<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> NextRecvUpd'_def next'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> NextPropagate'_next'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_next_imp_propagate_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds inv_init_imp_prop_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobPointstampsEq<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds cri.InvMsgInGlob<span class="main">)</span> <span class="main">(</span>smap exchange_config <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"alw Next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="main">(</span>next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> prop_config <span class="bound">s</span> <span class="free">p</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_imp_propagate_next <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def alw_holds_smap_conv_comp<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any Tracker trace is a valid Propagate trace (using the transitive closure of next, since
tracker may take multiple propagate steps at once).›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> spec_imp_propagate_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>holds init_config <span class="keyword1">aand</span> alw <span class="main">(</span>relates <span class="main">(</span>next'<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_exchange_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cri.alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_next_imp_propagate_next <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FullSpec_def InitConfig_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Safety proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_satisfied<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cri.InvGlobNonposImpRecordsNonpos <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_init_imp_prop_safe <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"InvGlobPointstampsEq <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_combined <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>cri.records <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"init <span class="free">c</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc0</span></span> <span class="skolem"><span class="skolem">t0</span></span> <span class="keyword2"><span class="keyword">where</span></span> delayed<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">t0</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">loc1</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>exchange_config <span class="free">c</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">t0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nrec_pts_delayed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> as<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> as<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t2</span><span class="main">.</span> <span class="bound">t2</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">t2</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="free">c</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> help_lemma delayed
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvGlobPointstampsEq_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_init_imp_prop_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_combined_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_safe_combined<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds safe_combined<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_inv_init_imp_prop_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvGlobPointstampsEq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> alwD alw_holds2 safe_satisfied<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_safe_combined2<span class="main">:</span> <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds safe_combined2<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> exch_alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_safe_combined<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop safe_combined_implies_safe_combined2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier<span class="main">:</span>
  <span class="quoted"><span class="quoted">"FullSpec <span class="free">s</span> <span class="main">⟹</span> 
    alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> worklists_vacant_to <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">b</span> <span class="main">⟶</span>
      <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier <span class="main">(</span>c_pts <span class="main">(</span>prop_config <span class="bound">c</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> alw_prop_invs<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_iff_implied_frontier_vacant all_imp_alw <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> alw_mp<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>