<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Exchange</title>
</head>


<body>
<div class="head">
<h1>Theory Exchange</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Exchange
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
    <a href="Auxiliary.html">Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_temp <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset list"</span></span>
  c_glob <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_caps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span>
  c_data_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> multiset"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Description of the configuration:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> global, all progress messages currently in-flight from p to q
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_data_msg <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> global, capabilities carried by in-flight data messages
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_temp <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, aggregated progress updates of worker p that haven't been sent yet
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, worker p's conservative approximation of all capabilities in the system
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> local, worker p's capabilities

global = state of the whole system to which no worker has access
local = state that is kept locally by each worker and which it can access
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">context</span></span> order <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">timestamps</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{#</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">#}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vacant_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vacant_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonpos_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonpos_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported_strong</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">justified</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">justified</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">⟶</span> supported <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> supported_strong <span class="free">M</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_def supported_def supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> le_less_trans less_le_trans nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> order.order_iff_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">justified_with</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">justified_with</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">t</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
       zcount <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
    zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans dual_order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_zeroD order.order_iff_strict not_less_iff_gr_or_eq order_class.order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PositiveImplies</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PositiveImplies</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="comment1">― ‹A worker can mint capabilities greater or equal to any owned capability›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minting_self</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minting_self</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈#</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Sending messages mints a capability at a strictly greater pointstamp›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minting_msg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minting_msg</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">∈#</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">records</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">records</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span>UNIV<span class="main">.</span> c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="main">(</span>c_data_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> sum_list <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">GlobalIncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">p'</span> <span class="main">∈</span> UNIV<span class="main">.</span> IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="comment1">(* (GlobalIncomingInfo c 0 q q) sums up all info incoming at q *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobalIncomingInfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹Capabilities have non-negative multiplicities›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹The pointstamps in glob are exactly those in nrec›</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="comment1">― ‹All capabilities are being tracked›</span>
      c_data_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>

<span class="comment1">(* Processor receives a capability, i.e. in timely: receives a data message *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvcap'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvcap'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈#</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_caps <span class="main">:=</span> <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span><span class="main">,</span>
              c_data_msg <span class="main">:=</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvcap</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvcap</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> next_recvcap' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Can minting of capabilities be described as a refinement of the Abadi model?
Short answer: No, not in general.
Long answer:
Could slightly modify Abadi model, such that a capability always comes with a multiplicity 2^64 (or
similar, could be parametrized over arbitrarily large constant). In that case minting new
capabilities can be described as an upright change, dropping one of the capabilities, to make the
change upright. This only works as long as no capability is required more than the constant number
of times.
Issues:
- Not fully general, due to the arbitrary constant
- Not clear whether refinement proofs would be easier than simply altering the model to support the operations
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Rationale for the condition on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
In Abadi next_performop' has the premise <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> int <span class="main"><span class="main">(</span></span>count <span class="free"><span class="free">Δneg</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c0</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
(records corresponds to the global field nrec in that model)
which means the processor performing the transition must verify that this condition is met.
Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is "global" state, which no processor can know, an implementation of
this protocol has to include some other protocol or reasoning for when it is safe to do this
transition.

Naively using a processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to approximate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and justify
transitions can cause a race condition, where a processor drops a pointstamp, e.g.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δneg</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">#}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, after which <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but other processors might still
use the pointstamp to justify the creation of pointstamps that violate the safety property.

Instead we model ownership of pointstamps, calling "owned pointstamps" <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹capabilities›</span></span>}, which are
tracked in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_caps <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In place of nrec we define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is the sum of
all capabilities, as well as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_data_msg <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which contains the capabilities carried by data
messages. Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">p</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> zcount <span class="main"><span class="main">(</span></span>c_caps <span class="free"><span class="free">c</span></span> <span class="bound"><span class="bound">p</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>records <span class="free"><span class="free">c</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, our condition
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> int <span class="main"><span class="main">(</span></span>count <span class="free"><span class="free">Δneg</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> zcount <span class="main"><span class="main">(</span></span>c_caps <span class="free"><span class="free">c0</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implies the one on nrec in Abadi's model.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Conditions in performop:

The performop transition takes three msets of pointstamps, Δneg Δmint_msg Δmint_self
Δneg contains dropped capabilities (a subset of c_caps)
Δmint_msg contains pairs (p,t), where a data message is sent (i.e. capability added to the pool), creating a capability at t, owned by p
Δmint_self contains pointstamps minted and owned by worker p

Δneg in combination with Δmint_msg also allows any upright updates to be made as in the Abadi model,
meaning this definition allows strictly more behaviors.

The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δmint_msg</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{#}</span></span> <span class="main"><span class="main">∨</span></span> zmset_of <span class="free"><span class="free">Δmint_self</span></span> <span class="main"><span class="main">-</span></span> zmset_of <span class="free"><span class="free">Δneg</span></span> <span class="main"><span class="main">≠</span></span> <span class="keyword1"><span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> condition ensures that
no-ops aren't possible. However, it's still possible that the combined Δ is empty. E.g. a processor
has capabilities 1 and 2, uses cap 1 to send a message, minting capability 2. Simultaneously it
drops a capability 2 (for unrelated reasons), cancelling out the overall change but shifting a
capability to the pool, possibly with a different owner than itself.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_performop'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">=</span>
    <span class="comment1">― ‹Δpos contains all positive changes, Δ the combined positive and negative changes›</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Δpos</span> <span class="main">=</span> timestamps <span class="main">(</span>zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span><span class="main">;</span>
        <span class="bound">Δ</span> <span class="main">=</span> <span class="bound">Δpos</span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∨</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>
    <span class="comment1">― ‹Pointstamps added in Δmint_self are minted at p›</span>
    <span class="main">∧</span> minting_self <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span>
    <span class="comment1">― ‹Pointstamps added in Δmint_msg correspond to sent data messages›</span>
    <span class="main">∧</span> minting_msg <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span>
    <span class="comment1">― ‹Worker immediately knows about dropped and minted capabilities›</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_caps <span class="main">:=</span> <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δmint_self</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">Δneg</span></span></span><span class="main">)</span><span class="main">,</span>
    <span class="comment1">― ‹Sending a data message creates a capability, once that message arrives. This is modelled as
        a pool of capabilities that may (will) appear at processors at some point.›</span>
              c_data_msg <span class="main">:=</span> c_data_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Δmint_msg</span></span></span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_performop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">.</span> next_performop' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">Δneg</span> <span class="bound">Δmint_msg</span> <span class="bound">Δmint_self</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_sendupd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">#}</span> <span class="keyword1">in</span>
      <span class="bound">γ</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="main">∧</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_sendupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> next_sendupd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">tt</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvupd'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
      c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">[]</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> next_recvupd' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>next_performop <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_sendupd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_recvupd <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_recvcap <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> holds init_config <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw next <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobNonposUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobNonposUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> nonpos_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RecordsVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RecordsVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> RecordsVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Other stuff›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_induct_select <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty select<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> finite <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">T</span> <span class="main">⊂</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">s</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">∧</span> finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> empty select<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_induct_decompose_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> comm_monoid_add<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> T
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> psubset_imp_ex_mem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">z</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> minting_msg_add_records<span class="main">:</span> <span class="quoted"><span class="quoted">"minting_msg <span class="free">C1</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span> <span class="main">⟹</span> minting_msg <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minting_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_strict_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">lemma</span></span> disj3_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span> <span class="main">∨</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_zmset_conclude_predicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">#}</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_holds2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>shd <span class="free">ss</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw.simps holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_remove1_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> zmset_of <span class="main">(</span>remove1_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> timestamps_zmset_of_pair_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="main">{#</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">#}</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> timestamps_image_zmset_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">{#</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">#}</span> <span class="main">=</span> timestamps <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_unfold image_mset_cong prod.collapse prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_invariant_to_spec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> init_config <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> holds <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> next <span class="bound">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration stream"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="main">(</span>shd <span class="skolem">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw next <span class="skolem">sa</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> holds <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> nxt <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">sa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> alw.cases alw_invar assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init_config <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sa</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> timestamps_sum_distrib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> timestamps <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> timestamps <span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_add_diff_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'c</span> zmultiset<span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_if_distrib_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">::</span><span class="main">{</span>group_add<span class="main">,</span>comm_monoid_add<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="bound">a</span> <span class="main">-</span> <span class="free">Y</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">-</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_conv_add_uminus<span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> Sum_eq_pick_changed_elem<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_distrib_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> if_distrib_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">a</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_if_distrib_add'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">Y</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_if_distrib_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> elems_eq_sum_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_zmset_of<span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> timestamps_zmset_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="main">=</span> zmset_of <span class="main">{#</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vacant_upto_add<span class="main">:</span> <span class="quoted"><span class="quoted">"vacant_upto <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> vacant_upto <span class="free">b</span> <span class="free">t</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonpos_upto_add<span class="main">:</span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">a</span> <span class="free">t</span> <span class="main">⟹</span> nonpos_upto <span class="free">b</span> <span class="free">t</span> <span class="main">⟹</span> nonpos_upto <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonpos_nonpos <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonzero_lt_gtD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lt_add_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Transition lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_performopD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Δmint_msg</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∨</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"minting_self <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="quoted"><span class="quoted">"minting_msg <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">Δmint_msg</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_temp <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span>  <span class="main">=</span> c_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span> <span class="main">+</span> <span class="free">Δmint_msg</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_caps <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_performop_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>
      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def change
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_diff_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> zmset_of_plus<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>
      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="skolem">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="skolem">q</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_zmset_pre change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_sendupdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="free">p'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">then</span> c_temp <span class="free">c0</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p'</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">then</span> c_msg <span class="free">c0</span> <span class="free">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span><span class="main">]</span> <span class="keyword1">else</span> c_msg <span class="free">c0</span> <span class="bound">p'</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> c_caps <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_sendupd_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> records_def change<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>
                                      <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                                      <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> IncomingInfo_def change<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ii <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>
                               <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span>
                               <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> IncomingInfo_def change<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q</span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free">c0</span> <span class="free">p'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">tt</span><span class="main">#}</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_recvupdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> c_temp <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p'</span> <span class="bound">q'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> tl <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> c_msg <span class="free">c0</span> <span class="bound">p'</span> <span class="bound">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_glob <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">q</span> <span class="main">:=</span> c_glob <span class="free">c0</span> <span class="free">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> c_caps <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvupd'_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_recvupd_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span>
                                <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p'</span> <span class="free">q'</span>
                                <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> records_def change<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="main">0</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def change <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_hd_tl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span>
                                   <span class="keyword1">then</span> IncomingInfo <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p'</span> <span class="free">q'</span>
                                   <span class="keyword1">else</span> IncomingInfo <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  IncomingInfo_def change <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_list_hd_tl drop_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c1</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c0</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ii<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_tl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">q</span> <span class="keyword1">then</span> InfoAt <span class="free">c0</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="keyword1">else</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_tl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_recvcapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈#</span> c_data_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_temp <span class="free">c1</span> <span class="main">=</span> c_temp <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_msg <span class="free">c1</span> <span class="main">=</span> c_msg <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_glob <span class="free">c1</span> <span class="main">=</span> c_glob <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_caps <span class="free">c1</span> <span class="main">=</span> <span class="main">(</span>c_caps <span class="free">c0</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"c_data_msg <span class="free">c1</span> <span class="main">=</span> c_data_msg <span class="free">c0</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvcap'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_recvcap_complexD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c1</span> <span class="main">=</span> GlobalIncomingInfo <span class="free">c0</span>"</span></span>
    <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"records <span class="free">c1</span> <span class="main">=</span> records <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def change fun_upd_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmset_of_remove1_mset <span class="dynamic"><span class="dynamic">algebra_simps</span></span> records_def change<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">=</span> IncomingInfo <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c1</span> <span class="main">=</span> GlobalIncomingInfo <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="free">c1</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="free">k</span> <span class="free">p'</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_next_recvupd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">.</span> next_recvupd' <span class="free">c0</span> <span class="bound">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span>
      exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">c0</span></span></span><span class="main"><span class="main"><span class="main">⦇</span></span></span>c_msg <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> tl <span class="main"><span class="main"><span class="main">(</span></span></span>c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="bound"><span class="bound"><span class="bound">p'</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span>
                   c_glob <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">if</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">then</span></span></span> c_glob <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> hd <span class="main"><span class="main"><span class="main">(</span></span></span>c_msg <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="free"><span class="free"><span class="free">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">else</span></span></span> c_glob <span class="free"><span class="free"><span class="free">c0</span></span></span> <span class="bound"><span class="bound"><span class="bound">q'</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">⦈</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Facts about justifiedness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"justified <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> justified_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It's sufficient to show justified for least pointstamps in M.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> justified_leastI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> supported_strong <span class="free">M</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_alt supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear linear local.le_imp_less_or_eq preorder_class.le_less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C1</span> <span class="free">M1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C2</span> <span class="free">M2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C1</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="main">(</span><span class="free">M1</span><span class="main">+</span><span class="free">M2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_leastI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M1</span> <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="comment1">(* symmetric cases *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' <span class="comment1">(* anything less than s' is 0 in M1 *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M1</span> <span class="main">+</span> <span class="free">M2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M2</span> <span class="skolem">s'</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* trivial contradiction *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def add_nonpos_neg<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_pos <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_add_same_cancel1 dual_order.strict_trans2 pos_add_strict zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_0 zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> not_ex
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_nonpos_neg<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order.strict_trans1 less_imp_le not_le not_less_iff_gr_or_eq order_class.dual_order.strict_trans2 supported_strong_def<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="bound">t'</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_left_left assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_cancel_left_right add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nonzero_lt_gtD<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="comment1">(* symmetric case *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' <span class="comment1">(* anything less than s' is 0 in M1 *)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M1</span> <span class="main">+</span> <span class="free">M2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M1</span> <span class="skolem">s'</span>"</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* trivial contradiction *)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def add_neg_nonpos<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s''
                    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_pos_nonneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_0 zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M1</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> supported_strong_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt nonpos_upto_def supported_strong_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
                assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> less_add_same_cancel1 dual_order.strict_trans1 less_imp_le not_less order_class.order.not_eq_order_implies_strict order_class.order.strict_implies_order<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="bound">t'</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_cancel_left_left assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_le sublist_order.add_less zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> justified <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> justified_add sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> justified_add_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C'</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span><span class="main">+</span><span class="free">C'</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> justified_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_add_zmset_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>add_zmset <span class="free">t</span> <span class="free">C</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_zmset_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_records<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> count <span class="free">Δ</span> <span class="bound">t</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> justified_leastI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def supported_strong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">note</span></span> case3 <span class="main">=</span> 3
      <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Ms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ms<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> least s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_add_msg_delta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_msg <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Δt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> Δt<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≥</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_less assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_class.order.not_eq_order_implies_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def order_class.antisym<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s'</span></span><span class="main">≤</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supported_strong_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> not_less
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> le_less_linear least local.eq_refl local.order.strict_trans1 nonpos_upto_def supported_strong_def sublist_order.add_less zcount_union<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Δt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Δt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_add_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_self <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less count_inI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_pos_nonneg order.ordering_axioms of_nat_0_le_iff ordering.strict_trans1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_left add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_eq_zero_iff local.dual_order.order_iff_strict of_nat_eq_0_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> least nonpos_upto_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_self_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> order.not_eq_order_implies_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Facts about justified_with'ness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_add_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C1</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_with_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_leastI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span>
       zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_alt
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> t'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans2 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">t'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">t'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> t'<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> order.not_eq_order_implies_strict t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C1</span> <span class="free">M</span> <span class="free">N1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C1</span> <span class="free">N1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C2</span> <span class="free">N2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C1</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C2</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C1</span><span class="main">+</span><span class="free">C2</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N1</span><span class="main">+</span><span class="free">N2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> justified_with_leastI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> count_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> count_t<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N1</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C1</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">N1</span> <span class="bound">s'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans order.strict_trans1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N2</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> least order.strict_trans s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"supported_strong <span class="free">N2</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C2</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s</span> <span class="main">≥</span> zcount <span class="free">C2</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C2</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N2</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">N2</span> <span class="skolem">s'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> s'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">N1</span><span class="main">+</span><span class="free">N2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N1</span> <span class="skolem">s'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> least order.strict_trans s'<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> not_less
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> nonneg<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> order.ordering_axioms order_class.order.irrefl order_class.order.strict_trans2 ordering.strict_trans s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_cancel_left_right assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans order_class.antisym s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_cancel_left_right assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans not_le order_class.antisym order_class.order.strict_trans2 s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> s<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_cancel_left_right add_strict_increasing2 assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_le order_class.dual_order.irrefl order_class.dual_order.strict_trans2 pos_add_strict s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order_class.order.strict_trans2 subset_zmset.le_add_same_cancel1 subseteq_zmset_def zcount_empty<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N1</span> <span class="main">+</span> <span class="free">N2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C1</span> <span class="main">+</span> <span class="free">C2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> N2t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N2</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 4 assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> not_less zcount_union
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> N2t<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N1</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE disjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_right add_neg_neg dual_order.strict_implies_order nonpos_upto_def order_class.order.not_eq_order_implies_strict zcount_union<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> least less_trans<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_pos_nonneg assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_trans zcount_union<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le not_less<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add_cancel_right_right add_neg_neg assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> least less_trans not_less order_class.order.not_eq_order_implies_strict pos_add_strict<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 conjI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> least <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.comm_neutral add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_sum'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified_with <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sum.insert_remove<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="free">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> justified <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">N</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> insert
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> sum.insert_remove<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_sum<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zcount_sum
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_add_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">+</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel2 assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_less preorder_class.le_less_trans zcount_union<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_add_msg_delta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"minting_msg <span class="free">C</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">∈#</span><span class="free">Δ</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> order.strict_trans order.strict_trans1 s<span class="main">(</span>1<span class="main">)</span> not_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_int_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_less <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> count <span class="free">Δ</span> <span class="bound">t</span> <span class="main">≤</span> zcount <span class="free">C</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI justified_with_leastI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> Mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mt<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> Mt <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="free">N</span> <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≥</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>  <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> diff_add_cancel zcount_union zcount_zmset_of_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="free">C</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">C</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="free">N</span> <span class="main">-</span> zmset_of <span class="free">Δ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">note</span></span> case3 <span class="main">=</span> 3
      <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ns<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">N</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Ns<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">N</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">N</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="free">C</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">C</span> <span class="skolem">s</span> <span class="main">=</span> zcount <span class="free">N</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 4<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PositiveImplies_justified_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="free">C</span> <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"PositiveImplies <span class="free">M</span> <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> justified_with_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> PositiveImplies_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> justified_with_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="free">C</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>add_zmset <span class="free">c</span> <span class="free">C</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_zmset_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_records<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_performop'_preserves_justified_with<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">+</span> timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_diff<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_msg_delta<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_same<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> minting_msg_add_records<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_increasing<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_msg_delta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_add_same<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> minting_msg_add_records<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> next_performopD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add_increasing<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvRecordCount›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvRecordCount states that for every processor, its local approximation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"c_glob c q"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and the sum of all incoming progress updates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"GlobalIncomingInfoAt c q"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> together are equal
to the sum of all capabilities in the system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvRecordCount</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvRecordCount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> records <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">+</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_config_implies_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvRecordCount <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sendupd_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_sendupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvcap_preserves_InvRecordCount<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def complex_change change<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_preserves_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvRecordCount <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> performop_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sendupd_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvupd_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvcap_preserves_InvRecordCount <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_invariant_to_spec init_config_implies_InvRecordCount next_preserves_InvRecordCount
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nxt.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvCapsNonneg and InvRecordsNonneg›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvCapsNonneg states that elements in a processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"c_caps c p"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> always have
non-negative cardinality. InvRecordsNonneg lifts this result to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"records c"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvCapsNonneg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvCapsNonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvRecordsNonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvRecordsNonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_config_implies_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvCapsNonneg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">Δ<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Δ<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_performop'_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> of_nat_0_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sendupd_performs_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvCapsNonneg_def next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_recvupd'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> recvcap_preserves_InvCapsNonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def next_recvcap'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> next_preserves_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvCapsNonneg <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sendupd_performs_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvupd_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recvcap_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvCapsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_invariant_to_spec next_preserves_InvCapsNonneg init_config_implies_InvCapsNonneg
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvRecordsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordsNonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"holds InvCapsNonneg"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> alw_InvCapsNonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> all_imp_alw<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def InvRecordsNonneg_def records_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_nonneg_nonneg sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Resulting lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_caps_pos_records<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span>UNIV<span class="main">.</span> c_caps <span class="free">c</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> records_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹SafeRecordsMono›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The records in the system are monotonic, i.e. once <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"records c"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains no records up
to some timestamp t, then it will stay that way forever.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeRecordsMono</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeRecordsMono</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> RecordsVacantUpto <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> RecordsVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_RecordsVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c0</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c1</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> InvRecordsNonneg <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δpos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Δpos</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> InvRecordsNonneg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.not_eq_order_implies_strict InvRecordsNonneg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Δ_in_nrec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_diff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> zero_lt_diff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> zero_lt_add_disj<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> pos_caps_pos_records<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> less_imp_le<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> pos_caps_pos_records<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> nrec0s<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> vacant_upto_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex_change
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nrec0s<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add_0<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> not_le
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Δ_in_nrec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans pos_zcount_in_zmset s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vacant_upto_def zcount_ne_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> s_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def vacant_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next'_preserves_RecordsVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvRecordsNonneg <span class="free">c1</span> <span class="main">⟹</span> RecordsVacantUpto <span class="free">c0</span> <span class="free">t</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> RecordsVacantUpto <span class="free">c1</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> performop_preserves_RecordsVacantUpto<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def records_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def records_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_recvcap_complexD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_next_implies_alw_SafeRecordsMono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alw next <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvCapsNonneg<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvRecordsNonneg<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw SafeRecordsMono <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next'_def SafeRecordsMono_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> next'_def next'_preserves_RecordsVacantUpto alw_holds2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_SafeRecordsMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeRecordsMono <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_next_implies_alw_SafeRecordsMono alw_InvRecordsNonneg alw_InvCapsNonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> spec_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvJustifiedII and InvJustifiedGII›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹These two invariants state that any net-positive change in the sum of incoming progress updates
is "justified" by one of several statements being true.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvJustifiedII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvJustifiedII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvJustifiedGII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvJustifiedGII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Auxilliary lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given some zmset M justified wrt to (caps c0 p), after a performop (M + Δ) is justified wrt to
(c_caps c1 p). This lemma captures the identical argument used for preservation of InvTempJustified
and InvJustifiedII.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> next_performop'_preserves_justified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δpos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span> <span class="main">+</span> zmset_of <span class="free">Δmint_self</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?Δpos</span> <span class="main">-</span> zmset_of <span class="free">Δneg</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> complex_change <span class="main">=</span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> inv0 <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">q</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="var">?M1</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_change<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">∨</span> zcount <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="comment1">― ‹M was already positive at t in c0›</span>
      <span class="keyword1"><span class="command">note</span></span> Mcount <span class="main">=</span> 1
      <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> Mcount<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">s</span> <span class="main">⟹</span> zcount <span class="free">M</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def supported_strong_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation_neg<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> le_less_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">using</span></span> less_imp_le order_trans order_class.order.not_eq_order_implies_strict <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> count1s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_le<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> nosupp<span class="main">[</span><span class="operator">unfolded</span> nonpos_upto_def supported_strong_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> least dual_order.strict_trans2 s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> Δinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δ</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>3<span class="main">)</span> count1s s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Δinc change<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> change<span class="main">(</span>9<span class="main">)</span> fun_upd_same zcount_union zcount_diff
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">u'</span></span><span class="main">&lt;</span><span class="skolem">u</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">u'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans order_class.order.not_eq_order_implies_strict<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> count1u<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> nocaps<span class="main">[</span><span class="operator">unfolded</span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> fun_upd_same<span class="main">]</span> dual_order.strict_trans<span class="main">[</span><span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> u<span class="main">(</span>2<span class="main">)</span> u<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="var">?M1</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def
            <span class="keyword1"><span class="command">using</span></span> least dual_order.strict_implies_order dual_order.strict_trans2 s<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> count1u dual_order.strict_trans s<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> supported_strong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> nosupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.not_eq_order_implies_strict<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> Δcounts<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δneg</span> <span class="bound">s</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δmint_self</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> count <span class="free">Δmint_msg</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>2<span class="main">)</span> nocaps s<span class="main">(</span>1<span class="main">)</span> order_class.order.not_eq_order_implies_strict
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_msg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> caps_le_ii0<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> nle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span> nle s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Δcounts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> least dual_order.strict_trans2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nosupp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> count0s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> inv0<span class="main">[</span><span class="operator">OF</span> count0s<span class="main">]</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> dual_order.strict_trans s<span class="main">(</span>1<span class="main">)</span> supported_strong_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> caps_le_ii0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="comment1">(* positive and negative changes to a least pointstamp are directly reflected in c_caps *)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span> change<span class="main">(</span>9<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P zcount_union zcount_diff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> complex_change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.antisym<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹Adding Δ made M positive at t in c1›</span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> nosupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> supported_strong <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nocaps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> InvCapsNonneg_def assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> order_class.le_less performop_preserves_InvCapsNonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="var">?M1</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> caps_le<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">Δneg</span> <span class="skolem">t</span> <span class="main">&lt;</span> zcount <span class="var">?Δpos</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="free">Δmint_self</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add.commute add.left_neutral not_gr_zero of_nat_0 zero_lt_diff zcount_diff zcount_of_mset zcount_union zcount_zmset_of_nonneg<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> local.dual_order.trans order_class.order.not_eq_order_implies_strict<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' u
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> local.dual_order.strict_trans2 local.less_imp_le order_class.order.not_eq_order_implies_strict<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> Δcounts<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δneg</span> <span class="bound">s</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> count <span class="free">Δmint_self</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> count <span class="free">Δmint_msg</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>2<span class="main">)</span> nocaps s<span class="main">(</span>1<span class="main">)</span> order_class.order.not_eq_order_implies_strict
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s'
              <span class="keyword1"><span class="command">using</span></span> nocaps<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> int <span class="main">(</span>count <span class="free">Δneg</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="bound">s'</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p s'
              <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> minting_msg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span>"</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> caps_le_ii0<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> nle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?M1</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> complex_change<span class="main">(</span>3<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> complex_change<span class="main">(</span>4<span class="main">)</span> nle s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Δcounts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> less<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> less least dual_order.strict_trans2
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nosupp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> count0s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> inv0<span class="main">[</span><span class="operator">OF</span> count0s<span class="main">]</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disj3_split<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="free">M</span> <span class="skolem">s</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="var">?M1</span> <span class="skolem">u</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> least nosupp<span class="main">[</span><span class="operator">unfolded</span> supported_strong_def nonpos_upto_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> dual_order.strict_trans<span class="main">[</span><span class="operator">OF</span> less u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?Δpos</span> <span class="skolem">u</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Δcounts<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> s<span class="main">(</span>3<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> u<span class="main">(</span>2<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="free">Δmint_self</span> <span class="skolem">u</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>timestamps <span class="main">(</span>zmset_of <span class="free">Δmint_msg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> gr0I <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_caps <span class="free">c0</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_self_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> minting_msg_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command">using</span></span> local.order.strict_iff_order <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> u<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
              <span class="keyword1"><span class="command">using</span></span> caps_le_ii0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> count0t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> eq caps_le change<span class="main">(</span>9<span class="main">)</span> complex_change<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> s<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> count0t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> local.order.not_eq_order_implies_strict s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"justified <span class="main">(</span>c_caps <span class="free">c1</span> <span class="free">p</span><span class="main">)</span> <span class="var">?M1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> justified_leastI<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Lemma proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> InvJustifiedII_implies_InvJustifiedGII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvJustifiedGII_def
    InvJustifiedII_def
    GlobalIncomingInfo_def
    records_def
    InvCapsNonneg_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> justified_add_records justified_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_config_implies_InvJustifiedII<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def InvJustifiedII_def justified_alt IncomingInfo_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p' q
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified<span class="main"><span class="main">[</span></span>
        <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>
        next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
        next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sendupd_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def justified_alt supported_strong_def next_sendupdD<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p' q t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> next_sendupd_complexD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> next_sendupd_complexD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> if_P<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> if_P<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> drop_all<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> drop_all<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_diff<span class="main">)</span>
          <span class="comment1">― ‹The justified condition ensures that anything remaining in temp satisfies this invariant›</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> next_sendupdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvJustifiedII_def
    next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
    next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> recvcap_preserves_InvJustifiedII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvJustifiedII_def justified_alt supported_strong_def next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> next_recvcapD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvJustifiedII_def justified_alt supported_strong_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next'_preserves_InvJustifiedII<span class="main">:</span>
  <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvJustifiedII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    next'_def
    performop_preserves_InvJustifiedII
    recvcap_preserves_InvJustifiedII
    recvupd_preserves_InvJustifiedII
    sendupd_preserves_InvJustifiedII
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvJustifiedII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvJustifiedII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvJustifiedII <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvJustifiedGII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvJustifiedGII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvTempJustified›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvTempJustified</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvTempJustified</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> justified <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_config_implies_InvTempJustified<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvTempJustified <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvTempJustified_def
  <span class="keyword1"><span class="command">using</span></span> justified_add_records<span class="main">[</span><span class="operator">OF</span> justified_empty<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> recvcap_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvTempJustified_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">frule</span> justified_add_records<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{#</span></span></span><span class="free"><span class="free"><span class="free">t</span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

<span class="keyword1"><span class="command">lemma</span></span> sendupd_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">tt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span> InvTempJustified_def
  <span class="keyword1"><span class="command">using</span></span> next_sendupdD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_InvTempJustified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvTempJustified_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performopD<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> fun_upd_apply
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_P<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified<span class="main"><span class="main">[</span></span>
        <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> InvTempJustified_def<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>
        next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
        next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvTempJustified_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next'_preserves_InvTempJustified<span class="main">:</span>
  <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span> <span class="main">⟹</span> InvTempJustified <span class="free">c0</span> <span class="main">⟹</span> next' <span class="free">c0</span> <span class="free">c1</span> <span class="main">⟹</span> InvTempJustified <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    next'_def
    performop_preserves_InvTempJustified
    recvcap_preserves_InvTempJustified
    recvupd_preserves_InvTempJustified
    sendupd_preserves_InvTempJustified
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvTempJustified<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvTempJustified<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvTempJustified<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvTempJustified <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposImpRecordsNonpos›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposImpRecordsNonpos states that each processor's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"c_glob <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a conservative
approximation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"records <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobNonposImpRecordsNonpos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobNonposImpRecordsNonpos</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> nonpos_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> nonpos_upto <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobVacantImpRecordsVacant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobVacantImpRecordsVacant</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> RecordsVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposImpRecordsNonpos <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvGlobNonposImpRecordsNonpos_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonpos_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t q u
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> gvu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">sa</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uleqt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="comment1">― ‹u is pointstamp that violates InvGlobNonposImpRecordsNonpos›</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="comment1">― ‹u' is the least pointstamp with positive nrec›</span>
    <span class="keyword1"><span class="command">with</span></span> uleqt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order_zmset_exists_foundation<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">― ‹from the nrec count we know that GII also has positive count›</span>
    <span class="keyword1"><span class="command">from</span></span> u'<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> gvu <span class="keyword1"><span class="command">have</span></span> pos_gii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?GII</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' diff_eq_eq less_add_same_cancel1 order_class.order.strict_trans1 zcount_diff<span class="main">)</span>
      <span class="comment1">― ‹Case distinction on which part of the partition GII's u is in›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Original proof from Abadi paper, change is justified by uprightness›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?GII</span> <span class="skolem">u'</span>"</span></span>
        <span class="comment1">― ‹uprightness gives us a lesser pointstamp with negative count in GII..›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?GII</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order supported_strong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="comment1">― ‹..which is also negative in nrec..›</span>
      <span class="keyword1"><span class="command">with</span></span> u'<span class="main">(</span>3<span class="main">)</span> v<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> InvRecordCount_def add.commute gvu less_add_same_cancel2 dual_order.trans not_le order_class.dual_order.strict_trans1 zcount_union<span class="main">)</span>
        <span class="comment1">― ‹..contradicting InvNrecNonneg›</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> InvRecordsNonneg_def
        <span class="keyword1"><span class="command">using</span></span> order_class.leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Change is justified by strictly lesser pointstamp in nrec›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">u'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
        <span class="comment1">― ‹v is a strictly lesser positive count in nrec..›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="comment1">― ‹..which contradicts the fact that we obtained u' as the least, positive pointstamp in nrec›</span>
      <span class="keyword1"><span class="command">with</span></span> u'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Change is justified by records›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"zcount <span class="var">?GII</span> <span class="skolem">u'</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvRecordCount_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gvu u'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> pos_gii assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedGII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> pos_gii<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹InvGlobVacantImpRecordsVacant is the one proved in the Abadi paper. We prove
InvGlobNonposImpRecordsNonpos, which implies this.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvGlobVacantImpRecordsVacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobNonposUpto <span class="free">c</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> InvGlobNonposImpRecordsNonpos_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RecordsVacantUpto <span class="free">c</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> nonpos_upto_def vacant_upto_def InvRecordsNonneg_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_class.order.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantImpRecordsVacant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobNonposImpRecordsNonpos<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobNonposImpRecordsNonpos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobVacantImpRecordsVacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobVacantImpRecordsVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposImpRecordsNonpos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹SafeGlobVacantUptoImpliesStickyNrec›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the main safety property proved in the Abadi paper.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_SafeGlobVacantUptoImpliesStickyNrec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SafeRecordsMono <span class="free">s</span> <span class="main">⟹</span> holds InvGlobVacantImpRecordsVacant <span class="free">s</span> <span class="main">⟹</span> SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobVacantImpRecordsVacant_def SafeRecordsMono_def SafeGlobVacantUptoImpliesStickyNrec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_SafeGlobVacantUptoImpliesStickyNrec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_iff_sdrop invs_imp_SafeGlobVacantUptoImpliesStickyNrec alw_SafeRecordsMono alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvGlobNonposEqVacant›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The least pointstamps in glob are always positive, i.e. nonpos_upto and vacant_upto on glob
are equivalent.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobNonposEqVacant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobNonposEqVacant</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">=</span> GlobNonposUpto <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvGlobNonposEqVacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedGII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> safe <span class="main">=</span> invs_imp_InvGlobNonposImpRecordsNonpos<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> InvGlobNonposImpRecordsNonpos_def nonpos_upto_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">,</span> <span class="operator">THEN</span> mp<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> nonneg <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordsNonneg_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> count <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordCount_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobNonposUpto <span class="free">c</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="free">c</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
      <span class="comment1">― ‹Obtain the least, negative pointstamp in glob›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command">using</span></span> nv<span class="main">[</span><span class="operator">unfolded</span> vacant_upto_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> elem_order_zmset_exists_foundation<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> order.ordering_axioms nonpos_upto_def np order_class.le_less ordering.trans zcount_ne_zero_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="comment1">― ‹No records ≤ s can exist, since that would violate InvGlobNonposImpRecordsNonpos›</span>
    <span class="keyword1"><span class="command">have</span></span> norec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟹</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> local.order.ordering_axioms nonneg nonpos_upto_def np order_class.antisym_conv ordering.trans s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> safe<span class="main">)</span>
        <span class="comment1">― ‹Hence GII must be positive at s›</span>
    <span class="keyword1"><span class="command">have</span></span> gii<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> count<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> s<span class="main">(</span>2<span class="main">)</span> norec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute less_add_same_cancel1 zcount_union<span class="main">)</span>
        <span class="comment1">― ‹which means it must be justified by one of these three disjuncts›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="free">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedGII_def justified_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> gii<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="comment1">― ‹s can't be supported_strong, since either glob or records would have to be positive at the support›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> norec count s<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute add.left_neutral less_le preorder_class.less_irrefl zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="comment1">― ‹no lesser capabilities exist›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> norec s<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> dual_order.order_iff_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3 <span class="comment1">― ‹no capabilities at s exist›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> norec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> gii <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvGlobNonposEqVacant_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonpos_upto_def vacant_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobNonposEqVacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobNonposEqVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    alw_InvJustifiedGII
    alw_InvRecordCount
    alw_InvRecordsNonneg
    invs_imp_InvGlobNonposEqVacant
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_iff_sdrop holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹InvInfoJustifiedWithII and InvInfoJustifiedWithGII›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoJustifiedWithII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoJustifiedWithII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified_with <span class="main">(</span>c_caps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoJustifiedWithGII</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoJustifiedWithGII</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> justified_with <span class="main">(</span>records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_config_implies_InvInfoJustifiedWithII<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvInfoJustifiedWithII_def justified_with_def InfoAt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This proof relies heavily on the addition properties summarized in the lemma
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> "next_performop'_preserves_justified_with"<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> performop_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_performop' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p'</span> <span class="free">Δneg</span> <span class="free">Δmint_msg</span> <span class="free">Δmint_self</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span><span class="main">=</span><span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_performop_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> next_performopD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_diff_eq if_P fun_upd_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_performop'_preserves_justified_with<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def justified_with_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less justified_with_def next_performop_complexD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> next_performopD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sendupd_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_sendupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p'</span> <span class="free">tt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithII_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command">note</span></span> complex <span class="main">=</span> next_sendupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_sendupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> length <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"justified_with <span class="main">(</span>c_caps <span class="free">c1</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free">c1</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> InvInfoJustifiedWithII_def Suc_eq_plus1 Suc_le_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> change<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> complex<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">)</span></span> order_class.less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> temp0<span class="main">:</span> <span class="quoted"><span class="quoted">"c_temp <span class="free">c0</span> <span class="skolem">p</span> <span class="main">=</span> InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">+</span> c_temp <span class="free">c1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex change
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"PositiveImplies <span class="main">(</span>InfoAt <span class="free">c1</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="free">c0</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> PositiveImplies_def complex
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> iitemp<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="free">c1</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> c_temp <span class="free">c1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> change<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> PositiveImplies_justified_with<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> iitemp temp0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> change
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempJustified_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_right_left complex<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> justified_with_leastI preorder_class.less_asym InfoAt_def zcount_union<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complex change
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvInfoJustifiedWithII_def
    next_recvupd_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
    next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> recvcap_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvcap' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    InvInfoJustifiedWithII_def
    next_recvcap_complexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
    next_recvcapD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvInfoJustifiedWithGII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvInfoJustifiedWithGII_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def records_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_add_records<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> justified_with_sum<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithII_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvJustifiedII_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvCapsNonneg_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next'_preserves_InvInfoJustifiedWithII<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvTempJustified <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> performop_preserves_InvInfoJustifiedWithII<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sendupd_preserves_InvInfoJustifiedWithII<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvInfoJustifiedWithII<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvcap_preserves_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvInfoJustifiedWithII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoJustifiedWithII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvTempJustified<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> holds.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_config_implies_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> alw_nxt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> next'_preserves_InvInfoJustifiedWithII
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvInfoJustifiedWithGII<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoJustifiedWithGII<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_InvCapsNonneg alw_InvInfoJustifiedWithII alw_InvJustifiedII alw_iff_sdrop holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> invs_imp_InvInfoJustifiedWithGII<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹SafeGlobMono and InvMsgInGlob›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The records in glob are monotonic. This implies the corollary InvMsgInGlob; No incoming message
carries a timestamp change that would cause glob to regress.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobMono</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobMono</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">⟶</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvMsgInGlob</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvMsgInGlob</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Auxilliary lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_InvMsgInGlob_imp_not_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> InvMsgInGlob <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span><span class="main">.</span> next_recvupd <span class="free">c0</span> <span class="bound">c1</span> <span class="main">∧</span> <span class="main">¬</span> SafeGlobMono <span class="free">c0</span> <span class="bound">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> npeq0 <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobNonposEqVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span>
    <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="skolem">c1</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c0</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InvMsgInGlob_def npeq0 nonpos_upto_def not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ex_next_recvupd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nvu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="skolem">c1</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def next_recvupdD<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>2<span class="main">)</span> t<span class="main">(</span>3<span class="main">)</span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>3<span class="main">)</span> nvu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SafeGlobMono <span class="free">c0</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> GII_eq_GIA<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="free">c</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> GlobalIncomingInfoAt <span class="free">c</span> <span class="free">q</span> <span class="keyword1">else</span> GlobalIncomingInfoAt <span class="free">c</span> <span class="free">q</span> <span class="main">-</span> hd <span class="main">(</span>c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def all_eq_sum_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def drop_Suc sum_list_hd_tl <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Lemma Proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_preserves_GlobVacantUpto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c0</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="free">c1</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> npeq1 <span class="main">=</span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobNonposEqVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> gvu0 <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> vacant_upto_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> nvu0 <span class="main">=</span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobVacantImpRecordsVacant_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> recordcount <span class="main">=</span> assms<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvRecordCount_def zmultiset_eq_iff zcount_union<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> change <span class="main">=</span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?κ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="free">c0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> change<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> iaκ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?κ</span> <span class="main">=</span> InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InfoAt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_conv_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> gvu1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> GlobVacantUpto <span class="free">c1</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">using</span></span> gvu1
    <span class="keyword1"><span class="command">unfolding</span></span> npeq1 nonpos_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> gvu0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> countκ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?κ</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvInfoJustifiedWithGII_def justified_with_alt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> countκ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> iaκ<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> zcount <span class="main">(</span>GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span> <span class="main">∧</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t'</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span> <span class="main">+</span> GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">&lt;</span> zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> globs<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gvu0 iaκ t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> change<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> globs <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">≤</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> t'<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> globs <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> npeq1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> nonpos_upto_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> vacant_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfo <span class="free">c0</span> <span class="main">1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">s'</span></span><span class="main">&lt;</span><span class="skolem">s</span><span class="main">.</span> zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> s<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>InfoAt <span class="free">c0</span> <span class="main">0</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> rc<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>records <span class="free">c0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_implies_order dual_order.strict_trans1 nvu0 s<span class="main">(</span>1<span class="main">)</span> t'<span class="main">(</span>1<span class="main">)</span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> change<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> s<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> rc t'<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> GII_eq_GIA InvRecordCount_def fun_upd_same
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> add.commute add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le recordcount<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">with</span></span> nvu0 t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> change<span class="main">(</span>1<span class="main">)</span> iaκ t'<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> GII_eq_GIA
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral preorder_class.less_irrefl recordcount<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recvupd_imp_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_recvupd' <span class="free">c0</span> <span class="free">c1</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SafeGlobMono <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SafeGlobMono_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q' t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recvupd_preserves_GlobVacantUpto<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_recvupdD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next'_imp_SafeGlobMono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SafeGlobMono <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_performopD<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_sendupdD<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> recvupd_imp_SafeGlobMono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> next_recvcapD<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvMsgInGlob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"InvInfoJustifiedWithGII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordsNonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="free">c0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> not_InvMsgInGlob_imp_not_SafeGlobMono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_imp_SafeGlobMono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_InvGlobNonposEqVacant<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvRecordCount<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recvupd_preserves_InvJustifiedII<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> recvupd_preserves_InvCapsNonneg<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvRecordsNonneg_def next_recvupd_complexD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_SafeGlobMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> spec<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw next <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobNonposEqVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobVacantImpRecordsVacant<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvInfoJustifiedWithGII<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next'_imp_SafeGlobMono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next'_imp_SafeGlobMono<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> alw_holds2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alwD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> spec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithGII<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvMsgInGlob<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvMsgInGlob<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithGII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvRecordsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop invs_imp_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SafeGlobMono_preserves_vacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c0</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c0</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeGlobMono_def vacant_upto_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_all_imp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">r</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">r'</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">r'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mono_rtranclp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_rel_and_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">r</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rtranclp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_invar_conclude_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rtranclp.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span> <span class="main">⟹</span> InvRecordsNonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvCapsNonneg_def InvRecordsNonneg_def records_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg add_nonneg_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_msg_in_glob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="free">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobNonposEqVacant <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvJustifiedII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvInfoJustifiedWithII <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvGlobVacantImpRecordsVacant <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvRecordCount <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvCapsNonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="free">c</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InvGlobNonposEqVacant_def vacant_upto_def nonpos_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> hd <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="bound">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="skolem">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> c_msg <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="skolem">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> tl <span class="main">(</span>c_msg <span class="skolem">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_next_recvupd<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> while_some<span class="main">:</span>
    <span class="quoted"><span class="quoted">"while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> hd <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">c'</span><span class="main">.</span> next_recvupd' <span class="bound">c</span> <span class="bound">c'</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measure_while_option_Some<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> Min <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">&lt;</span></span> length <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">=</span></span> c_msg <span class="bound"><span class="bound">c</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">!</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust_sel list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Min_less_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_less_eq Suc_pred hd_conv_nth list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_gr_zero not_less_zero<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth nth_tl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_le_eq Suc_pred' diff_less diff_less_mono hd_conv_nth length_tl list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_gr_zero nth_tl zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> next_recvupd' <span class="bound">c0</span> <span class="bound">c1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span> <span class="quoted"><span class="quoted">"c_msg <span class="skolem">c1</span> <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="skolem">c1</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjunct2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> while_option_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ while_some<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">d</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> set <span class="main"><span class="main">(</span></span>c_msg <span class="bound"><span class="bound">d</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c0</span></span> <span class="bound"><span class="bound">c1</span></span><span class="main"><span class="main">.</span></span> next_recvupd' <span class="bound"><span class="bound">c0</span></span> <span class="bound"><span class="bound">c1</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="free">c</span></span> <span class="bound"><span class="bound">d</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set_cases r<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_next_recvupd<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="operator">OF</span> _ while_some<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="bound">c</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> empty_iff hd_Cons_tl list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r set_ConsD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> while_option_stop<span class="main">[</span><span class="operator">OF</span> while_some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> invs_trancl<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span> <span class="main">∧</span> InvJustifiedII <span class="bound">c1</span> <span class="main">∧</span> InvGlobNonposEqVacant <span class="bound">c1</span> <span class="main">∧</span> InvInfoJustifiedWithII <span class="bound">c1</span> <span class="main">∧</span> InvGlobVacantImpRecordsVacant <span class="bound">c1</span> <span class="main">∧</span> InvRecordCount <span class="bound">c1</span> <span class="main">∧</span> InvCapsNonneg <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_rel_and_invar<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> c1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvJustifiedII<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> next_preserves_InvRecordCount<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvCapsNonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvJustifiedII_implies_InvJustifiedGII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> InvCapsNonneg_imp_InvRecordsNonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvGlobNonposEqVacant<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> recvupd_preserves_InvInfoJustifiedWithII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvInfoJustifiedWithGII<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> invs_imp_InvInfoJustifiedWithGII<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next'_imp_SafeGlobMono<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next'_def<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>7<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_InvGlobVacantImpRecordsVacant<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trancl_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">c0</span> <span class="bound">c1</span><span class="main">.</span> SafeGlobMono <span class="bound">c0</span> <span class="bound">c1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">c</span> <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rtranclp_all_imp_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vacant_c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="skolem">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SafeGlobMono_preserves_vacant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vacant<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> InvMsgInGlob<span class="main">:</span> <span class="quoted"><span class="quoted">"InvMsgInGlob <span class="skolem">c1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtranclp_invar_conclude_last<span class="main">[</span><span class="operator">OF</span> invs_trancl<span class="main">]</span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> invs_imp_InvMsgInGlob<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> invs_imp_InvInfoJustifiedWithGII InvCapsNonneg_imp_InvRecordsNonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="skolem">c1</span> <span class="free">q</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> InvMsgInGlob<span class="main">[</span><span class="operator">unfolded</span> InvMsgInGlob_def<span class="main">]</span> c1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> vacant_c1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_msg_glob<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span> <span class="main">∈</span> set <span class="main">(</span>c_msg <span class="bound">c</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_glob <span class="bound">c</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobNonposEqVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvJustifiedII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvInfoJustifiedWithII<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvGlobVacantImpRecordsVacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvRecordCount<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> alw_InvCapsNonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_InvMsgInGlob<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> invs_imp_msg_in_glob<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> holds.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>