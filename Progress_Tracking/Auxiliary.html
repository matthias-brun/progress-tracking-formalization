<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Auxiliary</title>
</head>


<body>
<div class="head">
<h1>Theory Auxiliary</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Auxiliary
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
    <span class="quoted">"<a href="../../AFP/Nested_Multisets_Ordinals/Signed_Multiset.html">Nested_Multisets_Ordinals.Signed_Multiset</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹General›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> UNIV_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> UNIV <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">::</span> group_add<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> sum_list <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>tl <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_minus_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>int<span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> min_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> take_take_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_eq_append_nonempty<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lhs_rhs_0_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_cartesian1<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">A</span> <span class="main">×</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="free">a</span> <span class="main">`</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">×</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_comp_intersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intersect_Collect_conv_comprehension<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> Collect <span class="free">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_Collect_conv_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Collect <span class="free">P</span> <span class="main">=</span> Collect <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_distinct_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⋃</span></span><span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∈</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">..</span></span> card <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span>  length <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> distinct <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">∧</span></span> set <span class="bound"><span class="bound">xs</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> card_mono distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> GreatestI2_ex_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∃</span><span class="bound">k</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">P</span> <span class="bound">k</span><span class="main">;</span>  <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span>  <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>Greatest <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> GreatestI_ex_nat Greatest_le_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_eq_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> last <span class="free">xs</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_tl_empty_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> tl <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_eq_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span>hd <span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3-<span class="main"><span class="main">)</span></span> in_set_conv_nth insert_Diff insert_Diff_single insert_iff list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Sums›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> elems_eq_sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">M</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Sum_eq_pick_changed_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="free">g</span> <span class="free">m</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">=</span> sum <span class="free">g</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> elems_eq_sum_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> insert True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonpos_sum_elems_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">::</span>int<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_add_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">∪</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pos_ex_elem_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_eq_sum_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f0</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f1</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f0</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_if_distrib_add<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="free">b</span> <span class="main">+</span> <span class="free">Y</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sum_eq_pick_changed_elem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_cartesian_if<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> <span class="free">a'</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a'</span><span class="main">=</span><span class="skolem">x</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> insert_cartesian1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.neutral sum.reindex inj_on_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> insert_cartesian1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.neutral<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_eq_split_sums<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">h</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Partial orders›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_finite_set_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> less_le_not_le order_trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> less_le_not_le order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> order.strict_implies_order order.strict_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_finite_set_obtain_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> order"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_finite_set_exists_foundation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Multisets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_eq_minus_plus_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_mset_subset_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">⊆#</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">⊆#</span> sum <span class="free">f</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.add_increasing2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.add_increasing<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_sum_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆#</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">y</span> <span class="main">-</span> <span class="free">M</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="free">y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elems_eq_sum_eq subset_mset.diff_add_assoc2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> subset_mset_subset_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> multiset_diff_union_assoc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> union_left_cancel<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_sum_eq_sum_minus_delta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="free">g</span> <span class="free">m</span> <span class="main">-</span> <span class="free">Δ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">⊆#</span> <span class="free">g</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">=</span> sum <span class="free">g</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> elems_eq_sum_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> insert True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset_subset_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nonzero_count<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> count <span class="keyword1"><span class="command">unfolding</span></span> multiset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_count<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_nonzero_count<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elems_eq_sum_mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mset_eq_pick_changed_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="free">g</span> <span class="free">m</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> count <span class="free">M</span> <span class="free">m</span> <span class="main">*</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_in_sum_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">MM</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">f</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">MM</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> <span class="free">f</span> <span class="bound">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">MM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_plus_subseteq_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆#</span> <span class="free">N</span> <span class="main">-</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mset_subset_eq_add_right subset_mset.le_diff_conv2 subset_mset.order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_take_drop_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> mset <span class="free">xs</span> <span class="main">#}</span> <span class="main">⊆#</span> <span class="free">q</span> <span class="main">⟹</span> <span class="main">{#</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> mset <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">#}</span> <span class="main">⊆#</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{#</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> mset <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_plus_subseteq_minus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> image_mset_union mset_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Signed Multisets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_nonemptyI<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≠</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_zmset_of_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_union_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">A</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">B</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zcount_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Un<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_nonzero_count finite_nonzero_count<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">M</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def fst_conv snd_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zcount_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Un<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_nonzero_count finite_nonzero_count<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem">M</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_mset_def fst_conv snd_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_zcount_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_inI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_elem_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.order_iff_strict zcount_eq_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_le_sum_mset_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="main">{#</span><span class="free">f</span> <span class="bound">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_le_sum_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">{#</span><span class="free">f</span> <span class="bound">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_zmset_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_of <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_of_Diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆#</span> <span class="free">M</span> <span class="main">⟹</span> zmset_of <span class="free">M</span> <span class="main">-</span> zmset_of <span class="free">N</span> <span class="main">=</span> zmset_of <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_right_cancel diff_add_cancel diff_add_zmset_swap subset_mset.diff_add zmset_of_add_mset zmset_of_plus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="main">(</span>abs_zmultiset <span class="main">(</span><span class="free">Mp</span><span class="main">,</span><span class="free">Mn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Mn</span><span class="main">-</span><span class="free">Mp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_neg.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_pos <span class="main">(</span>abs_zmultiset <span class="main">(</span><span class="free">Mp</span><span class="main">,</span><span class="free">Mn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">Mp</span><span class="main">-</span><span class="free">Mn</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_pos.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_sum_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_sum_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">⟹</span> mset_neg <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.right_neutral mset_pos_as_neg zcount_zmset_of_nonneg zmset_of_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zmultiset.abs_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mset_neg_minus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Diff_eq_empty_iff_mset mset_subset_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_zcount_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mset_neg_empty_iff<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_emptyI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mset_neg_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> in_zmset_conv_pos_neg_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_mset_pos in_diff_zcount mem_zmset_of mset_pos_neg_partition nat_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_in_iff zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_zmset_notin_mset_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉#</span> mset_pos <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_zmset_conv_pos_neg_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_zmset_notin_mset_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉#</span> mset_neg <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_zmset_conv_pos_neg_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_pos_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_zmset_conv_pos_neg_disj<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_mset_neg_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_zmset_conv_pos_neg_disj<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_zmset_eq_set_mset_union<span class="main">:</span> <span class="quoted"><span class="quoted">"set_zmset <span class="free">M</span> <span class="main">=</span> set_mset <span class="main">(</span>mset_pos <span class="free">M</span><span class="main">)</span> <span class="main">∪</span> set_mset <span class="main">(</span>mset_neg <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_mset_pos_in_zmset in_mset_neg_in_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> member_mset_pos_iff_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_pos <span class="free">M</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_in_iff pos_zcount_in_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> member_mset_neg_iff_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> mset_neg <span class="free">M</span> <span class="main">⟷</span> zcount <span class="free">M</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> member_mset_pos_iff_zcount mset_pos_uminus neg_le_0_iff_le not_le zcount_uminus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pos_mset_neg_disjoint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset_pos <span class="free">Δ</span><span class="main">)</span> <span class="main">∩</span> set_mset <span class="main">(</span>mset_neg <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_mset_pos_iff_zcount member_mset_neg_iff_zcount<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> <span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> zcount <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">MM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_filter_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">{#</span> <span class="bound">t'</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="bound">t'</span><span class="main">=</span><span class="free">t</span> <span class="main">#}</span> <span class="free">t</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_filter_zmset_in_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> filter_zmset <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_zmset zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_filter_zmset_pos_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_filter_zmset less_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_filter_zmset_neg_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>filter_zmset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="free">M</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> count_filter_zmset less_irrefl<span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> update_zmultiset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
<span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span> <span class="bound">T</span> <span class="bound">D</span><span class="main">.</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">D</span><span class="main">&gt;</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">A</span> <span class="main">+</span> replicate_mset <span class="main">(</span>nat <span class="bound">D</span><span class="main">)</span> <span class="bound">T</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span>
                    <span class="keyword1">else</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span> <span class="main">+</span> replicate_mset <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def if_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_update_zmultiset<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>update_zmultiset <span class="free">M</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> zcount <span class="free">M</span> <span class="free">t'</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_zmset_exists_foundation
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_less_linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_zmset_exists_foundation_neg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">M</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> zcount <span class="free">M</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms order_zmset_exists_foundation_neg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_less_linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> elem_order_zmset_exists_foundation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">u</span> <span class="main">&lt;</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_finite_set_exists_foundation<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set_zmset<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> elem_order_zmset_exists_foundation'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">&lt;</span><span class="bound">s</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms elem_order_zmset_exists_foundation
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_less_linear<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹image_zmset›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> image_zmset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>image_mset <span class="bound">f</span> <span class="bound">M</span><span class="main">,</span> image_mset <span class="bound">f</span> <span class="bound">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> image_mset_union<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_comprehension_zmset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/</span><span class="keyword1">.</span> _ <span class="keyword1">:#z</span> _<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_comprehension_zmset"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/</span><span class="keyword1">.</span> _ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{#</span><span class="free">e</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">#}</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> image_zmset <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span> <span class="free">M</span>"</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">{#</span><span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="main">{#</span><span class="free">f</span> <span class="free">x</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">+</span> image_zmset <span class="free">f</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_Diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="free">A</span> <span class="main">-</span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> image_zmset <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_zmset_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_image_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> mset_neg <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> multiset_eq_iff count_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mset_subseteq_mono mset_subset_eqI mset_subset_eq_count<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_zcount_image_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mset_neg_zcount_nonneg mset_neg_image_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_add_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"image_zmset <span class="free">f</span> <span class="main">(</span>add_zmset <span class="free">t</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> add_zmset <span class="main">(</span><span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_zcount_image_zmset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M t f
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Mp Mn
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> count_diff count_image_mset_ge_count image_mset_Diff less_le_trans subseteq_mset_def zero_less_diff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_zmset_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_fun <span class="main">(</span>pcr_zmultiset <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_set <span class="main">(=)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Mp</span><span class="main">,</span> <span class="bound">Mn</span><span class="main">)</span><span class="main">.</span> set_mset <span class="bound">Mp</span> <span class="main">∪</span> set_mset <span class="bound">Mn</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="bound">Mp</span> <span class="bound">x</span> <span class="main">=</span> count <span class="bound">Mn</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> set_zmset"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def pcr_zmultiset_def cr_zmultiset_def
    rel_set_eq multiset.rel_eq set_zmset_def zcount.abs_eq count_eq_zero_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_image_zmset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_zmset <span class="free">M</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> Mp Mn
      <span class="keyword1"><span class="command">unfolding</span></span> count_image_mset int_sum
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_mset <span class="skolem">Mp</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_eq_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> set_mset <span class="skolem">Mn</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_eq_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> count <span class="skolem">Mp</span> <span class="bound">x</span> <span class="main">=</span> count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>set_mset <span class="skolem">Mp</span> <span class="main">∪</span> set_mset <span class="skolem">Mn</span><span class="main">)</span><span class="main">.</span> int <span class="main">(</span>count <span class="skolem">Mp</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> int <span class="main">(</span>count <span class="skolem">Mn</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.same_carrier<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">-`</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span> <span class="main"><span class="main"><span class="main">∩</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mp</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="skolem"><span class="skolem"><span class="skolem">Mn</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">-</span> <span class="var">?S2</span> <span class="main">=</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_empty_image_zmset_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">M</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_image_zmset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_image_zmset_in_zmset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zcount_image_zmset_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∉#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_zmset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_image_zmset<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Int_emptyI sum.empty vimage_singleton_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> t zcount_image_zmset_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> zcount_ne_zero_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_image_zmset_obtain_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">m</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>image_zmset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_zcount_in_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> image_zmset_pre<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> zmset_elem_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Streams›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">relates</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relatesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"relates <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> relates_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_relatesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> relatesI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> relates <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> holds_smap_conv_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"holds <span class="free">P</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> holds <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_holds_smap_conv_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="free">P</span><span class="main">)</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_relates<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>relates <span class="free">P</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relates_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Notation›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> AND  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">aand</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> OR   <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 60<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> IMPL <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">imp</span>"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> AND  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">aand</span>"</span> 70<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> OR   <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 65<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> IMPL <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">imp</span>"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Syntax bug workaround›</span></span>

<span class="comment1">(* temporary fix for incorrect zmset comprehension syntax *)</span>
<span class="keyword1"><span class="command">no_translations</span></span>
 <span class="quoted">"<span class="main">{#</span><span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">#}</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> filter_zmset <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">M</span>"</span>
<span class="keyword1"><span class="command">no_syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
 <span class="quoted">"_MCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">:#z</span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_syntax</span></span>
 <span class="quoted">"_MCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
 <span class="quoted">"_ZMCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>    <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
 <span class="quoted">"_ZMCollect"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>    <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">{#</span>_ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
 <span class="quoted">"<span class="main">{#</span><span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">#}</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="keyword1">CONST</span> filter_zmset <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">M</span>"</span>

<span class="comment1">(* temporary fix for incorrect zmset Ball/Bex syntax *)</span>
<span class="keyword1"><span class="command">no_translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Ball <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Bex <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
<span class="keyword1"><span class="command">no_syntax</span></span>
  <span class="quoted">"_MBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_MBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">no_syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_MBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_MBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_ZMBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_ZMBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_ZMBall"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∀</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="quoted">"_ZMBex"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">∃</span>_<span class="keyword1">:#<span class="hidden">⇩</span><sub>z</sub></span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">∀</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Ball <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>
  <span class="quoted">"<span class="main">∃</span><span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">A</span><span class="main">.</span> <span class="free">P</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Signed_Multiset.Bex <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="free">x</span><span class="main">.</span> <span class="free">P</span><span class="main">)</span>"</span>

<span class="comment1">(* Syntax for zmset comprehensions *)</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_comprehension_zmset'"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/ </span><span class="keyword1">|</span> _ <span class="keyword1">:#z</span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_comprehension_zmset'"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> zmultiset <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> zmultiset"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">{#</span>_<span class="keyword3">/ </span><span class="keyword1">|</span> _ <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> _<span class="keyword1">.</span><span class="keyword3">/ </span>_<span class="keyword1">#}</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">{#</span><span class="free">e</span> <span class="main">|</span> <span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">#}</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">{#</span><span class="free">e</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">{#</span> <span class="free">x</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">M</span><span class="main">.</span> <span class="free">P</span><span class="main">#}</span><span class="main">#}</span>"</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>