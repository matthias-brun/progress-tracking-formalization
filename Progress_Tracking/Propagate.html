<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Propagate</title>
</head>


<body>
<div class="head">
<h1>Theory Propagate</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Propagate
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Graph.html">Graph</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_work <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* worklists with not-yet-applied updates *)</span>
  c_pts  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* tracked point-stamps *)</span>
  c_imp  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="comment1">(* alive point-stamps ("implications") *)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">locale</span></span> dataflow_topology <span class="main">=</span> flow<span class="main">?</span><span class="main">:</span> graph <span class="quoted"><span class="free">summary</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">summary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">::</span> <span class="main">{</span>order<span class="main">,</span> monoid_add<span class="main">}</span> antichain"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">results_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'t</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> results_in_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t</span> <span class="main">0</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> results_in_mono_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t2</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> followed_by_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s1</span><span class="main">)</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span><span class="free">s1</span> <span class="main">+</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> no_zero_cycle<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc</span> <span class="free">loc</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> sum_path_weights <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> results_in_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t1</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t2</span> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≤</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s1</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="free">t</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> results_in_mono_raw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">path_summary</span> <span class="main">≡</span> path_weight"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">followed_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'sum</span> <span class="main">⇒</span> <span class="tfree">'sum</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">followed_by</span> <span class="main">≡</span> plus"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implications are always non-negative.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_implications_nonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_implications_nonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">unchanged</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zmset_frontier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zmset_frontier</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> zmset_of <span class="main">(</span>mset_set <span class="main">(</span>set_antichain <span class="main">(</span>frontier <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc</span><span class="main">.</span>
      c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">∧</span>
      c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">=</span> zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">after_summary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'sum</span> antichain <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">after_summary</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span> <span class="main">∈</span> set_antichain <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> image_zmset <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">frontier_changes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">frontier_changes</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> zmset_frontier <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">-</span> zmset_frontier <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_change_multiplicity'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_change_multiplicity'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
    <span class="comment1">― ‹n is the non-zero change in pointstamps at loc for timestamp t›</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="comment1">― ‹change can only happen at timestamps not in advance of implication-frontier›</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="comment1">― ‹at loc, t is added to pointstamps n times›</span>
     <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_pts <span class="main">:=</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="comment1">― ‹worklist at loc is adjusted by frontier changes›</span>
             c_work <span class="main">:=</span> <span class="main">(</span>c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span>
                frontier_changes <span class="main">(</span>update_zmultiset <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_change_multiplicity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_change_multiplicity</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> next_change_multiplicity' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cm_unchanged_worklist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">loc'</span> <span class="main">≠</span> <span class="free">loc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span> c_work <span class="free">c0</span> <span class="free">loc'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_propagate'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propagate'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="comment1">― ‹t is a least timestamp of all worklist entries›</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">t'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_imp <span class="main">:=</span> <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">:=</span> c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span><span class="main">)</span><span class="main">,</span>
              c_work <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span>
                  <span class="comment1">― ‹worklist entries for t are removed from loc's worklist›</span>
                    <span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="keyword1">then</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span>
                  <span class="comment1">― ‹worklists at other locations change by the loc's frontier change after adding summaries›</span>
                    <span class="keyword1">else</span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">loc'</span>
                           <span class="main">+</span> after_summary
                               <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">.</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">#}</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span><span class="free">summary</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_propagate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_propagate</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> next_propagate' <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">loc</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next'</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span>next_propagate <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> next_change_multiplicity <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> next' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cm_valid</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cm_valid</span> <span class="main">≡</span> nxt <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_change_multiplicity <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">impl</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_change_multiplicity <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> nxt <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">l</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="main">≡</span> holds init_config <span class="keyword1">aand</span> alw next"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next'_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> next_change_multiplicity next_propagate next_finish_init<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next' <span class="free">c0</span> <span class="free">c1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="free">c0</span> <span class="main">⟹</span> next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="free">c0</span> <span class="main">⟹</span> next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="bound">loc</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Auxiliary›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_change_multiplicity'_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">c'</span><span class="main">.</span> next_change_multiplicity' <span class="free">c</span> <span class="bound">c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pointstamps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_pts <span class="free">c</span><span class="main">)</span><span class="main">(</span><span class="free">loc</span> <span class="main">:=</span> update_zmultiset <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?worklist'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">loc'</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc'</span> <span class="main">+</span> frontier_changes <span class="main">(</span><span class="var">?pointstamps'</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⦇</span>c_pts <span class="main">:=</span> <span class="var">?pointstamps'</span><span class="main">,</span> c_work <span class="main">:=</span> <span class="var">?worklist'</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c</span> <span class="var">?c'</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c'</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frontier_change_zmset_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M1</span> <span class="main">-</span> frontier <span class="free">M0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> zcount <span class="main">(</span>zmset_frontier <span class="free">M0</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frontier_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frontier <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_frontier_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_frontier <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_empty_summary<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="free">M</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_frontier_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">-</span> frontier <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac_Diff_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_frontier_diff'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span> <span class="main">-</span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac_Diff_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_mem_frontier_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">-</span> frontier <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span> <span class="main">-</span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> M N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∉<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> M N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_neg_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_neg <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟹</span> mset_neg <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mset_neg_image_zmset mset_neg_sum_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="comment1">― ‹Changes in loc's frontier are reflected in the worklist of loc'.›</span>
<span class="keyword1"><span class="command">lemma</span></span> next_p_frontier_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span>
         c_work <span class="free">c0</span> <span class="free">loc'</span>
          <span class="main">+</span> after_summary
              <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free">c1</span> <span class="free">loc</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> summary_self next_propagate'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> configuration.equality<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_union<span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> after_summary <span class="free">M</span> <span class="free">S</span> <span class="main">+</span> after_summary <span class="free">N</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib after_summary_def<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: inv_imps_work_sum›</span></span>

<span class="comment1">― ‹Get timestamps in frontiers of loc's predecessor locations, apply respective summaries and
    return union of results.›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_frontiers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'loc</span> <span class="main">⇒</span> <span class="tfree">'t</span> zmultiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union_frontiers</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">summary</span> <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Implications + worklist is equal to the frontiers of pointstamps and all preceding nodes
    (after accounting for summaries).›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imps_work_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imps_work_sum</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">+</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span>
        <span class="main">=</span> zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span>"</span></span>

<span class="comment1">― ‹Version with zcount is easier to reason with›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imps_work_sum_zcount</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imps_work_sum_zcount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span> <span class="main">+</span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>
          <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_imps_work_sum_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span> <span class="main">⟷</span> inv_imps_work_sum_zcount <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_imps_work_sum_zcount_def inv_imps_work_sum_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmultiset_eq_iff<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> union_frontiers_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_neg_zcount_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_neg_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_p_union_frontier_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="free">loc'</span> <span class="main">=</span>
         union_frontiers <span class="free">c0</span> <span class="free">loc'</span>
          <span class="main">+</span> after_summary
              <span class="main">(</span>frontier_changes <span class="main">(</span>c_imp <span class="free">c1</span> <span class="free">loc</span><span class="main">)</span> <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">summary</span> <span class="free">loc</span> <span class="free">loc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zmultiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_of_mset image_zmset_Diff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sum_eq_pick_changed_elem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">UNIV</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> after_summary_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹init_config satisfies inv_imps_work_sum›</span>
<span class="keyword1"><span class="command">lemma</span></span> init_imp_inv_imps_work_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_def init_config_def<span class="main">)</span>

<span class="comment1">― ‹CM preserves inv_imps_work_sum›</span>
<span class="keyword1"><span class="command">lemma</span></span> cm_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Given CM at loc, t, we show result for loc', t'›</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">loc'</span> <span class="skolem">t'</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> cm'<span class="main">:</span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> cm <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> next_change_multiplicity'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> cm <span class="keyword1"><span class="command">have</span></span> unchanged_imps<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged c_imp <span class="free">c0</span> <span class="free">c1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> unchanged_union<span class="main">:</span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">locX</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">locX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">locX</span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> elems_eq_sum_eq<span class="main">)</span>
        <span class="comment1">― ‹For locations other than loc nothing changes.›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc'</span> <span class="main">≠</span> <span class="skolem">loc</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc'</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> loc cm <span class="keyword1"><span class="command">have</span></span> unchanged_worklist<span class="main">:</span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> loc cm <span class="keyword1"><span class="command">have</span></span> unchanged_frontier<span class="main">:</span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
       <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span>       <span class="skolem">loc'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> loc <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
                <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span>
          unchanged_imps
          unchanged_union
          unchanged_frontier
          unchanged_worklist
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iiws<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
      <span class="comment1">― ‹For pointstamps at location loc we make a case distinction on whether their "status" in
          the frontier has changed.›</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc'</span> <span class="main">=</span> <span class="skolem">loc</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">loc</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="comment1">― ‹If t appeared in the frontier›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> t'<span class="main">[</span><span class="operator">THEN</span> mem_frontier_diff<span class="main">]</span>
          <span class="comment1">― ‹then the worklist at t increased by 1›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> plus_minus_conv<span class="main">)</span>
            <span class="comment1">― ‹and the frontier at t increased by 1›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
              <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">[</span><span class="operator">THEN</span> frontier_change_zmset_frontier<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="comment1">― ‹If t disappeared from the frontier›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> t'<span class="main">[</span><span class="operator">THEN</span> mem_frontier_diff'<span class="main">]</span>
          <span class="comment1">― ‹then the worklist at t decreased by 1›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span>
            <span class="comment1">― ‹and the frontier at t decreased by 1›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
              <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> t'<span class="main">[</span><span class="operator">THEN</span> frontier_change_zmset_frontier<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="comment1">― ‹If t's multiplicity in the frontier didn't change›</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> a1 a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>frontier_changes <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> not_mem_frontier_diff<span class="main">)</span>
            <span class="comment1">― ‹then the worklist at t didn't change›</span>
        <span class="keyword1"><span class="command">with</span></span> cm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac_Diff_iff<span class="main">)</span>
            <span class="comment1">― ‹and the frontier at t didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a1 a2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ac_notin_Diff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ac_Diff_iff count_mset_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_mset_set<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> finite_set_antichain member_antichain.rep_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="comment1">― ‹and the sum didn't change›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_union
          <span class="comment1">― ‹hence, the invariant is preserved.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> iiws unchanged_imps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
            <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> loc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
          <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span>
              <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def inv_imps_work_sum_zcount inv_imps_work_sum_zcount_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹PR preserves inv_imps_work_sum›</span>
<span class="keyword1"><span class="command">lemma</span></span> p_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Given next_propagate for loc, t, we show the result for loc', t'.›</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">t</span> <span class="skolem">loc'</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="skolem">loc</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> next_propagate'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> unchanged_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged c_pts <span class="free">c0</span> <span class="free">c1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">=</span><span class="skolem">loc'</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> iiws
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_ps
        <span class="comment1">― ‹The t entries in loc's worklist are shifted to the implications.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>
         <span class="main">=</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">+</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="comment1">― ‹Since the implications of other locations don't change and loc can't have an edge to
              itself, union_frontiers at loc doesn't change.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">loc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> summary_self <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_eq_sum_eq arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Sum</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="comment1">― ‹For all the other timestamps the worklist and implications don't change.›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">tX</span> <span class="main">≠</span> <span class="skolem">t</span> <span class="main">⟹</span> zcount <span class="main">(</span>c_work <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span> <span class="main">=</span> zcount <span class="main">(</span>c_work <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tX</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">tX</span> <span class="main">≠</span> <span class="skolem">t</span> <span class="main">⟹</span> zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span> <span class="main">=</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">tX</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tX</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> loc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">=</span><span class="skolem">t'</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">≠</span><span class="skolem">loc'</span>"</span></span>
        <span class="comment1">― ‹The implications are unchanged at all locations other than loc.›</span>
      <span class="keyword1"><span class="command">from</span></span> p loc <span class="keyword1"><span class="command">have</span></span> unchanged_imps<span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> c_imp <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span> <span class="main">=</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> iiws
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_ps
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> unchanged_imps
          <span class="comment1">― ‹The worklist only changes if loc, loc' are connected.›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p loc sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> c_work <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="comment1">― ‹Since the implications only change at loc and loc is not connected to loc',
            union_frontiers doesn't change.›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p loc sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span> union_frontiers <span class="free">c0</span> <span class="skolem">loc'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_eq_sum_eq arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Sum</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
           <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span> <span class="main">≠</span> <span class="keyword1">{}<span class="hidden">⇩</span><sub>A</sub></span>"</span></span>
          <span class="comment1">― ‹union_frontiers at loc' changed by whatever amount the frontier changed.›</span>
        <span class="keyword1"><span class="command">note</span></span> iiws
          unchanged_imps
          unchanged_ps
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p' sum <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span>
           union_frontiers <span class="free">c0</span> <span class="skolem">loc'</span>
            <span class="main">+</span> after_summary
                <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> zmset_frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_p_union_frontier_change<span class="main">)</span>
            <span class="comment1">― ‹The worklist at loc' changed by the same amount›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p' sum <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"c_work <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">=</span>
           c_work <span class="free">c0</span> <span class="skolem">loc'</span>
            <span class="main">+</span> after_summary
                <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc</span><span class="main">)</span> <span class="main">-</span> zmset_frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc</span> <span class="skolem">loc'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_p_frontier_change<span class="main">)</span>
            <span class="comment1">― ‹The two changes cancel out.›</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc'</span> <span class="main">+</span> c_work <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>
         <span class="main">=</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c1</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc</span><span class="main">=</span><span class="skolem">loc'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def Let_def inv_imps_work_sum_zcount inv_imps_work_sum_zcount_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_preserves_inv_imps_work_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"holds inv_imps_work_sum <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>holds inv_imps_work_sum<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    cm_preserves_inv_imps_work_sum
    p_preserves_inv_imps_work_sum
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next'_inv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_iiws<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_imps_work_sum<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> init_imp_inv_imps_work_sum next_preserves_inv_imps_work_sum
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alw_invar <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_mono spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: inv_imp_plus_work_nonneg›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is never an update in the worklist that could cause implications to become negative.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_imp_plus_work_nonneg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_imp_plus_work_nonneg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span> <span class="main">+</span> zcount <span class="main">(</span>c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc</span><span class="main">)</span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iiws_imp_iipwn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_imp_plus_work_nonneg <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iiws'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_imps_work_sum_zcount <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_zcount<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> iiws'<span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_zcount_def<span class="main">,</span> <span class="operator">THEN</span> spec2<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_frontiers_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iiws <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_imp_plus_work_nonneg_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_iipwn<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_imp_plus_work_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> spec_imp_iiws iiws_imp_iipwn
    alw_mono holds_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariant: inv_implications_nonneg›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_imp_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def inv_implications_nonneg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cm_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_change_multiplicity'_def inv_implications_nonneg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> p_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next_propagate' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"inv_imp_plus_work_nonneg <span class="free">c0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def Let_def inv_implications_nonneg_def inv_imp_plus_work_nonneg_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_preserves_inv_implications_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds inv_implications_nonneg <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds inv_imp_plus_work_nonneg <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nxt <span class="main">(</span>holds inv_implications_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    cm_preserves_inv_implications_nonneg
    p_preserves_inv_implications_nonneg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next'_inv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_inv_implications_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_implications_nonneg<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iipwn<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_invar<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> init_imp_inv_implications_nonneg <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> next_preserves_inv_implications_nonneg
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_Diff<span class="main">:</span> <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> after_summary <span class="free">M</span> <span class="free">S</span> <span class="main">-</span> after_summary <span class="free">N</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_zmset_frontier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="free">M</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> obtain_frontier_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_zmset_exists_foundation<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frontier_unionD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">N</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ps_frontier_in_imps_wl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> union_frontiers_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">loc</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obtain_elem_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_finite_set_obtain_foundation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">s</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> zcount <span class="free"><span class="free"><span class="free">M</span></span></span> <span class="bound"><span class="bound"><span class="bound">s</span></span></span> <span class="main"><span class="main"><span class="main">&gt;</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">thesis</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms antichain_inverse frontier_def member_antichain.rep_eq
      in_minimal_antichain<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obtain_elem_zmset_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="free">M</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ps_in_imps_wl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">loc</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">u</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> obtain_elem_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ps_frontier_in_imps_wl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> member_antichain.rep_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> u <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span> <span class="main">+</span> c_work <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_le_after_summary_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zero_le_sum_single <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_le_zcount_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> image_zmset_single after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> forw_subst<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"zcount <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg_leq_bound<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set_antichain <span class="free"><span class="free">S</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">.</span></span> zcount <span class="main"><span class="main">{#</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="bound"><span class="bound">u</span></span><span class="keyword1"><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_lt_zcount_after_summary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="main">{#</span><span class="free">t</span><span class="keyword1">#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> int_one_le_iff_zero_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> one_le_zcount_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_zcount_after_summary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2 pos_zcount_image_zmset <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq zcount_sum after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum after_summary_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_zmset_of_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_of <span class="free">M</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_neg_image_zmset mset_neg_sum_set mset_neg_zcount_nonneg after_summary_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_zcount_union_frontiers<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">summary</span> <span class="free">l1</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>
    <span class="main">≤</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> member_le_sum<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pos_zcount_image_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_Sum_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">MM</span> <span class="main">⟹</span> after_summary <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> <span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">M</span><span class="main">∈</span><span class="free">MM</span><span class="main">.</span> after_summary <span class="main">(</span><span class="free">f</span> <span class="bound">M</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">MM</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_obtain_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="bound">t</span>"</span></span> <span class="comment1">(* could prove without this assumption *)</span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t'</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sum_pos_ex_elem_pos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ex_comm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pos_image_zmset_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_antichain<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> antichain <span class="main">{}</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_antichain.abs_eq mem_antichain_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">impWitnessPath</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">impWitnessPath</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
    path <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
    distinct <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>TO <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> impWitnessPathEx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> impWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc2</span> <span class="free">loc2</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path0<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> sum_path_weights <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> foldr_Nil list.map<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> impWitnessPath_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">longestImpWitnessPath</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">longestImpWitnessPath</span>  <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>
  impWitnessPath <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">loc'</span> <span class="bound">xs'</span><span class="main">.</span> impWitnessPath <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="bound">xs'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> length <span class="main">(</span><span class="bound">xs'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sums</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> set_antichain <span class="main">(</span><span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?sums</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span> <span class="main">×</span> <span class="var">?sums</span> <span class="main">×</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span> <span class="main">×</span> <span class="var">?sums</span> <span class="main">×</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'loc</span> set<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> member_antichain.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> longestImpWitnessPathEx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> longestImpWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">paths</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">paths</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> impWitnessPath <span class="free">c</span> <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> impWitnessPathEx<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">paths</span> <span class="main">⟶</span> <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">p</span>  <span class="main">&lt;</span> card <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">p</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="main">(</span><span class="bound">loc1</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">loc2</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="bound">loc1</span> <span class="bound">loc2</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> paths_def impWitnessPath_def less_Suc_eq_le finite_edges path_edge
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ex_has_greatest_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">paths</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> paths_def longestImpWitnessPath_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_first_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">l1</span> <span class="free">l2</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">l1'</span><span class="main">,</span><span class="free">s</span><span class="main">,</span><span class="free">l2'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l1</span> <span class="main">=</span> <span class="free">l1'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l1'</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path0E<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l1'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_witness_from_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">loc1</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>path <span class="bound">loc1</span> <span class="free">loc2</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span>  <span class="free">results_in</span> <span class="bound">t'</span> <span class="main">(</span>sum_path_weights <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> longestP<span class="main">:</span> <span class="quoted"><span class="quoted">"longestImpWitnessPath <span class="free">c</span> <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> longestImpWitnessPathEx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="main">(</span>TO <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">∨</span>
             <span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> verit_forall_inst<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_imps_work_sum_def not_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_pos_nonneg mem_zmset_frontier member_frontier_pos_zmset obtain_frontier_elem zcount_empty zcount_ne_zero_iff zcount_union zmset_frontier_empty<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> case1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> t' longestP
      <span class="keyword1"><span class="command">using</span></span> impWitnessPath_def longestImpWitnessPath_def dataflow_topology_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> case2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">+</span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> case2 cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> case_split2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_diff_cancel_left' in_diff_zcount zcount_ne_zero_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> case2_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> case2_1 mem_zmset_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> t' impWitnessPath_def longestImpWitnessPath_def dataflow_topology_axioms longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> case2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span>  union_frontiers <span class="free">c</span> <span class="skolem">loc1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> case_split2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc0</span></span> <span class="skolem"><span class="skolem">t0</span></span> <span class="skolem"><span class="skolem">s0</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc0 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t0</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc0</span><span class="main">)</span>"</span></span>
                                          <span class="quoted"><span class="quoted">"<span class="skolem">s0</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span><span class="free">summary</span> <span class="skolem">loc0</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
                                          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="skolem">s0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def set_zmset_def zcount_sum
          member_antichain.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zcount_image_zmset card_gt_0_iff
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">loc0</span><span class="main">,</span> <span class="skolem">s0</span><span class="main">,</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> path_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> impWitnessPath_def longestImpWitnessPath_def longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> is_path_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">loc0</span> <span class="free">loc2</span> <span class="var">?xs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> longestP
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil path_singleton path_trans loc0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="var">?xs'</span><span class="main">.</span>
              <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="main">(</span>TO <span class="main">(</span><span class="var">?xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> loc0<span class="main">(</span>3<span class="main">)</span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> loc0<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> followed_by_summary<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> distinctxs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> longestP
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> case_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs'</span>"</span></span>
          <span class="comment1">(* show that we have a longer longestImpWitnessPathEx ⟶ contradicition *)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="var">?xs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> longestP loc0<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> longestImpWitnessPath_def impWitnessPath_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> followed_by_summary t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> impPath<span class="main">:</span> <span class="quoted"><span class="quoted">"impWitnessPath <span class="free">c</span> <span class="skolem">loc0</span> <span class="free">loc2</span> <span class="var">?xs'</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_path_xs' case_distinct loc0<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> impWitnessPath_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?xs'</span> <span class="main">&gt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> longestImpWitnessPath <span class="free">c</span> <span class="skolem">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> impPath leD <span class="keyword1"><span class="command">unfolding</span></span> longestImpWitnessPath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> longestP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="var">?xs'</span>"</span></span>
          <span class="comment1">(* show that we have a non-increasing cycle along path (loc0, s0, loc1) # xs *)</span>
        <span class="keyword1"><span class="command">with</span></span> distinctxs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"TO <span class="main">(</span><span class="var">?xs'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">loc0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?xs'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> path_first_loc<span class="main">[</span><span class="operator">OF</span> path_xs<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> path_xs
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_to_eq_from<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r<span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> k<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t0</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">t0</span> <span class="main">(</span>sum_path_weights <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_zero_cycle<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc0</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"take <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?xs'</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"sum_path_weights <span class="main"><span class="main">(</span></span>take <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="var"><span class="var">?xs'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t0</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> is_path_xs' k  path_take_to <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> loc0<span class="main">(</span>1<span class="main">)</span> frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implication_implies_pointstamp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">loc'</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc'</span> <span class="free">loc</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≥</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="main">∧</span>
               <span class="main">(</span><span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> witness<span class="main">:</span>
    <span class="quoted"><span class="quoted">"path <span class="skolem">loc'</span> <span class="free">loc</span> <span class="skolem">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&gt;</span> zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc'</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms find_witness_from_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc'</span> <span class="free">loc</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>1<span class="main">)</span> path_path_weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>2<span class="main">)</span> results_in_mono<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> witness<span class="main">(</span>3<span class="main">)</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Proof of safe›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> results_in_sum_path_weights_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">loc2</span><span class="main">,</span> <span class="free">s</span><span class="main">,</span> <span class="free">loc3</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">results_in</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> followed_by_summary sum_path_weights_append_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">loc_imps_fw</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">(</span>c_imp <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">summary</span> <span class="free"><span class="bound"><span class="entity">loc2</span></span></span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">loc_imps_fw</span> <span class="free"><span class="bound"><span class="entity">loc1</span></span></span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span> <span class="main">(</span><span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">#}</span> <span class="main">+</span> c_imp <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">loc2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">loc3</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loc_imps_fw_conv_path<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span> <span class="main">⟹</span> path <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_conv_loc_imps_fw<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">M</span><span class="main">.</span> loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">M</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path0 <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> loc_imps_fw.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">xs</span> <span class="skolem">lbl</span> <span class="skolem">l3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> path <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> loc_imps_fw.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_summary_conv_loc_imps_fw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">M</span> <span class="bound">xs</span><span class="main">.</span> loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="bound">M</span> <span class="bound">xs</span> <span class="main">∧</span> sum_path_weights <span class="bound">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">loc1</span> <span class="free">loc2</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_weight_conv_path<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys xs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> path_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">loc2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subseq_sum_weights_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> le<span class="main">(</span>1<span class="main">)</span> path_sum <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_weight_conv_path<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_zmset_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">M</span><span class="main">#}</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_zmset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>ordered_comm_monoid_add<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_nonneg add_pos_nonneg add_nonneg_pos<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loc_imps_fw_M_in_implications<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_image_zmset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff mem_Collect_eq sum_pos_ex_elem_pos<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> riu_le_rit'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> results_in_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonneg_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> riu_le_rit' <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iiws<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> obtain_elem_frontier<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">u'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹Same as induction base case›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> disj
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loc_imps_fw_M_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_nonneg_nonneg sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_image_zmset assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inv_implications_nonneg_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> loc_imps_fw_implication_in_M<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_in_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="free">t</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> results_in_sum_path_weights_append<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_pos_nonneg<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">results_in</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">(</span></span>sum_weights <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">xs</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> loc_imps_fw_M_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> zcount_inI<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inv_implications_nonneg_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹impl_safe is essentially the same as pairwise_path_safe, without worklists›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">impl_safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">impl_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t'_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mxs<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> path_summary_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_implication_in_M<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> t'_zcount<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t'</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_M_in_implications<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> inM<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Safety for states where worklist is non-empty›</span>

<span class="keyword1"><span class="command">lemma</span></span> cm_preserves_impl_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"impl_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> impl_safe_def next_change_multiplicity'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cm_preserves_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"impl_safe <span class="free">c0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"next_change_multiplicity' <span class="free">c0</span> <span class="free">c1</span> <span class="free">loc</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> impl_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="skolem">loc2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> impl_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> imps<span class="main">:</span> <span class="quoted"><span class="quoted">"c_imp <span class="free">c1</span> <span class="main">=</span> c_imp <span class="free">c0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_change_multiplicity'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="comment1">― ‹`safe c1` variables›</span>
    <span class="keyword3"><span class="command">assume</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c1</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> obtain_frontier_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
    <span class="comment1">― ‹CM state changes:›</span>
    <span class="keyword3"><span class="command">assume</span></span> n_neq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c0</span> <span class="free">loc</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pointstamps<span class="main">:</span>
           <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc'</span><span class="main">.</span> c_pts <span class="free">c1</span> <span class="bound">loc'</span> <span class="main">=</span>
                    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">loc'</span> <span class="main">=</span> <span class="free">loc</span> <span class="keyword1">then</span> update_zmultiset <span class="main">(</span>c_pts <span class="free">c0</span> <span class="bound">loc'</span><span class="main">)</span> <span class="free">t</span> <span class="free">n</span>
                                   <span class="keyword1">else</span> c_pts <span class="free">c0</span> <span class="bound">loc'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c1</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹Trivial, because no new pointstamp could have appeared›</span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> u_c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c0</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pointstamps<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">loc1</span><span class="main">=</span><span class="free">loc</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="skolem">u</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> imps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u_c0 path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> n_neq_zero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> imps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">loc</span><span class="main">=</span><span class="skolem">loc1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="skolem">u</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> impl
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> member_frontier_pos_zmset<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> impl_safe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t''
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t''</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> results_in_mono<span class="main">(</span>1<span class="main">)</span> order_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> u path_sum <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_update_zmultiset pointstamps<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> safe<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 loc2 t s
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> next_change_multiplicity'_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> r<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹A better safe?›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">worklists_vacant_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">worklists_vacant_to</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">s</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_work <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">t'</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'loc</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_safe</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc1</span> <span class="bound">loc2</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc1</span><span class="main">)</span> <span class="bound">t</span>
                            <span class="main">∧</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc1</span> <span class="bound">loc2</span>
                            <span class="main">∧</span> worklists_vacant_to <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>
                <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span> <span class="main">≤</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Intuition: Unlike safe, inv_safe should be an invariant because it only claims the safety property
(_ ∈A frontier (c_imp _ _)) for pointstamps that can't be modified by future propagated
updates anymore (i.e. there are no upstream worklist entries which can result in a ≤ pointstamp).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_frontier_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span><span class="free">N</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer'</span>
  <span class="keyword1"><span class="command">unfolding</span></span> in_minimal_antichain
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_zero le_less mem_Collect_eq set_zmset_def zcount_diff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> worklists_vacant_to_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> worklists_vacant_to <span class="free">c</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> worklists_vacant_to_def
  <span class="keyword1"><span class="command">using</span></span> order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> loc_imps_fw_M_in_implications'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="free">loc1</span> <span class="free">loc2</span> <span class="free">M</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="bound">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_imps_fw.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">loc</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def eq_diff_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span> <span class="skolem">s</span> <span class="skolem">loc3</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">{#</span> <span class="free">results_in</span> <span class="bound">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="skolem">M</span> <span class="main">#}</span> <span class="skolem">t</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_image_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_iff mem_Collect_eq sum_pos_ex_elem_pos<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> vacant_to<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> worklists_vacant_to_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> zero_le results_in_mono<span class="main">(</span>2<span class="main">)</span> results_in_zero t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> vacant_to t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> riu_le_rit'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> results_in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> after_summary_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_eq_sum<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc3</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_nonneg_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> riu_le_rit' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> iiws<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> obtain_elem_frontier<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> in_frontier_diff<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t'
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> worklists_vacant_to_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">loc3</span></span> <span class="quoted"><span class="skolem">loc3</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> order_trans results_in_zero<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_elem_frontier<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inv_safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_safe_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> iiws <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> inv_imps_work_sum_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obtain_frontier_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> zcount_wl<span class="main">:</span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vacant<span class="main">[</span><span class="operator">unfolded</span> worklists_vacant_to_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">loc1</span></span> <span class="quoted"><span class="skolem">loc1</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral order.trans le_plus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> results_in_zero t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">from</span></span> t'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">+</span> zcount <span class="main">(</span>union_frontiers <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_frontiers_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t''</span><span class="main">.</span> <span class="bound">t''</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t''</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> iiws<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> zcount_wl
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_frontier_elem<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t''_zcount<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> path_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mxs<span class="main">:</span> <span class="quoted"><span class="quoted">"loc_imps_fw <span class="free">c</span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">M</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_path_weights <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> path_summary_conv_loc_imps_fw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> path_sum<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">M</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_implication_in_M<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> t''_zcount<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> vacant2<span class="main">:</span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_weights <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> worklists_vacant_to_trans t''<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vacant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">t''</span> <span class="main">(</span>sum_path_weights <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> loc_imps_fw_M_in_implications'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Mxs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> vacant2 inM<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mxs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> t''<span class="main">(</span>2<span class="main">)</span> t'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans results_in_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_conjI<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="free">Q</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_inv_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds inv_safe<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> holds inv_imps_work_sum <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∧</span></span> holds inv_implications_nonneg <span class="bound"><span class="bound">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_mono inv_safe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_worklists_vacant_to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">⟹</span> worklists_vacant_to <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> worklists_vacant_to_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_safe_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">⟹</span> inv_safe <span class="free">c</span> <span class="main">⟹</span> safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_safe_def safe_def worklists_vacant_to_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"safe <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> inv_safe<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹The algorithm computes the frontier implied by the pointstamps›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">zmset_pos</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">zmset_pos</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> zmset_of <span class="main">(</span>mset_pos <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">implied_frontier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implied_frontier</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">=</span> frontier <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_pos <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">implied_frontier_alt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implied_frontier_alt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span> <span class="main">=</span> frontier <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free"><span class="bound"><span class="entity">loc</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_frontier_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_frontier_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">M</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less minimal_antichain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> implied_frontier_alt_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span> <span class="bound">a'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc</span> <span class="free">loc2</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">a'</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI notI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">loc</span> <span class="skolem">a'</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="skolem">loc</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a' s' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pos_zcount_after_summary<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">loc</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lt <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_frontier_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lt assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
    <span class="keyword1"><span class="command">using</span></span> frontier_comparable_False
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implied_frontier_alt_in_pointstamps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">s</span> <span class="free">loc1</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="free">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="free">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> member_frontier_pos_zmset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sum_pos_ex_elem_pos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> after_summary_obtain_pre<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> loc1 a s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">loc1</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_implied_frontier_alt_in_implication_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> inv_safe_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">― ‹Pointstamp b in the implied_frontier_alt is caused by a pointstamp a and summary s
          and "results_in a s" is least among such pointstamps›</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc1_a_s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">loc</span> <span class="bound">a'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="bound">loc</span> <span class="free">loc2</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">results_in</span> <span class="bound">a'</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> implied_frontier_alt_in_pointstamps<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> implied_frontier_alt_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zcount_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> member_frontier_pos_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹From `safe` we know that pointstamp a is reflected in the implications by some
      poinstamp b' ≤ b›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe<span class="main">[</span><span class="operator">OF</span> zcount_ps loc1_a_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b'<span class="main">(</span>2<span class="main">)</span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> worklists_vacant_to_def flow.zero_le order_trans
          path_weight_refl zcount_inI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹but the pointstamp can't be strictly less, because we know that "results_in a s" is least›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">loc1'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1'</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> implication_implies_pointstamp<span class="main">[</span><span class="operator">OF</span> b'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≠</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> b'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> b'_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> loc1_a_s<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> loc1_a_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> a'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">with</span></span> b'_lt a'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leD less_le order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">― ‹Hence, the implied_frontier_alt pointstamp b is reflected in the implications›</span>
  <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> loc1_a_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_implication_frontier_in_implied_frontier_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="main">⟹</span> <span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>
        <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">t'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="skolem">loc2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">loc1</span> <span class="skolem">loc2</span> <span class="skolem">t</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> inv_safe_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_work <span class="free">c</span> <span class="skolem">loc</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="skolem">loc</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> results_in_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> worklists_vacant_to_def flow.zero_le
      order_trans path_weight_refl zcount_inI<span class="main">)</span>
  <span class="comment1">― ‹Pointstamp b in the implications is caused by a pointstamp a and a summary s›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">loc1</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> loc1_a_s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> path_summary <span class="skolem">loc1</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> implication_implies_pointstamp<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zcount_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_pts <span class="free">c</span> <span class="skolem">loc1</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> member_frontier_pos_zmset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> b_ria<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> loc1_a_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> safe<span class="main">[</span><span class="operator">OF</span> zcount_a loc1_a_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> loc1_a_s<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans2 frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹`results_in a s` is a candidate for inclusion in the implied_frontier_alt..›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span><span class="main">∑</span><span class="bound">loc'</span><span class="main">∈</span>UNIV<span class="main">.</span> after_summary <span class="main">(</span>zmset_frontier <span class="main">(</span>c_pts <span class="free">c</span> <span class="bound">loc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>path_summary <span class="bound">loc'</span> <span class="free">loc2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_sum<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> <span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> zcount_image_zmset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="comment1">― ‹..which means a pointstamp b' ≤ results_in a s must exist in the implied_frontier_alt..›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≤</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implied_frontier_alt_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> obtain_frontier_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="skolem">b'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> loc1_a_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> worklists_vacant_to_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> b'_frontier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_implied_frontier_alt_in_implication_frontier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹..and this pointstamp must be equal to b'›</span>
  <span class="keyword1"><span class="command">have</span></span> b'_ria<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">≠</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> b'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> b'_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">&lt;</span> <span class="free">results_in</span> <span class="skolem">a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> b'_frontier b'_lt b_ria assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> frontier_comparable_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">― ‹Hence, the implication frontier pointstamp b is reflected in the implied_frontier_alt›</span>
  <span class="keyword1"><span class="command">from</span></span> b' b'_ria b_ria <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implied_frontier_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implication_frontier_iff_implied_frontier_alt_vacant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"worklists_vacant_to <span class="free">c</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>
    ac_eq_iff
    in_implication_frontier_in_implied_frontier_alt<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    in_implied_frontier_alt_in_implication_frontier<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> next_propagate_implied_frontier_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_propagate <span class="free">c</span> <span class="free">c'</span> <span class="main">⟹</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span> <span class="main">=</span> implied_frontier_alt <span class="free">c'</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_propagate'_def implied_frontier_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> implication_frontier_eq_implied_frontier_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv_imps_work_sum <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"inv_implications_nonneg <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="free">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"frontier <span class="main">(</span>c_imp <span class="free">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">=</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ac_eq_iff implication_frontier_iff_implied_frontier_alt_vacant empty_worklists_vacant_to assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier_alt_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">loc</span><span class="main">.</span> c_work <span class="bound">c</span> <span class="bound">loc</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">⟶</span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">=</span> implied_frontier_alt <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alw_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_eq_implied_frontier_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_implication_frontier_eq_implied_frontier_alt_vacant<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span>
  alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> worklists_vacant_to <span class="bound">c</span> <span class="free">b</span> <span class="main">⟶</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> frontier <span class="main">(</span>c_imp <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> implied_frontier_alt <span class="bound">c</span> <span class="free">loc</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> spec_imp_iiws<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> alw_inv_implications_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> alw_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alw_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> implication_frontier_iff_implied_frontier_alt_vacant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> antichain_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="keyword1">∈<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zmset_frontier_zmset_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"zmset_frontier <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> zmset_pos <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subseteq_zmset_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> count_mset_set_if minimal_antichain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_mono_pos<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">A</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> image_zmset <span class="free">f</span> <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> image_zmset <span class="free">f</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subseteq_zmset_def zcount_image_zmset
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_mono sum_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_subset_iff antisym subsetI zcount_ne_zero_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_mono_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">K</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">K</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">K</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_zmset_def sum_mono zcount_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_summary_zmset_frontier<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"after_summary <span class="main">(</span>zmset_frontier <span class="free">A</span><span class="main">)</span> <span class="free">S</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> after_summary <span class="main">(</span>zmset_pos <span class="free">A</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> after_summary_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono_subseteq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_mset_mono_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ zmset_frontier_zmset_pos<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> frontier_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">A</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="free">B</span> <span class="bound">b</span> <span class="main">⟹</span>
  <span class="free">A</span> <span class="keyword1">⊆#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> frontier <span class="free">A</span> <span class="main">=</span> frontier <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minimal_antichain_def subseteq_zmset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_le less_le_trans zcount_ne_zero_iff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_le zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> implied_frontier_implied_frontier_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"implied_frontier <span class="main">(</span>c_pts <span class="free">c</span><span class="main">)</span> <span class="free">loc</span> <span class="main">=</span> implied_frontier_alt <span class="free">c</span> <span class="free">loc</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> implied_frontier_alt_def implied_frontier_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frontier_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zcount_sum sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono_subseteq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> after_summary_zmset_frontier<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_summary_def zcount_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zcount_image_zmset <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sum.not_neutral_contains_not_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zcount_ne_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u loc s t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtain_elem_frontier<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"c_pts <span class="free"><span class="free">c</span></span> <span class="skolem"><span class="skolem">loc</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">results_in</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> results_in_mono<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_nonneg_eq_0_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">loc</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_nonneg_eq_0_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> alw_implication_frontier_eq_implied_frontier_vacant <span class="main">=</span>
  alw_implication_frontier_eq_implied_frontier_alt_vacant<span class="main">[</span><span class="operator">folded</span> implied_frontier_implied_frontier_alt<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> implication_frontier_iff_implied_frontier_vacant <span class="main">=</span>
  implication_frontier_iff_implied_frontier_alt_vacant<span class="main">[</span><span class="operator">folded</span> implied_frontier_implied_frontier_alt<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>