<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Exchange_Abadi</title>
</head>


<body>
<div class="head">
<h1>Theory Exchange_Abadi</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Exchange_Abadi
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Auxiliary.html">Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'t</span> count_vec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> multiset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'t</span> delta_vec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> zmultiset"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vacant_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vacant_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nonpos_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonpos_upto</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported_strong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported_strong</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supported</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">supported</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upright</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upright</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> supported <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upright_alt<span class="main">:</span>  <span class="quoted"><span class="quoted">"upright <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">a</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> supported_strong <span class="free">a</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> upright_def supported_def supported_strong_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> dual_order.strict_trans1 order.strict_trans1 order_zmset_exists_foundation'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">beta_upright</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">::</span> order delta_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">beta_upright</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free"><span class="bound"><span class="entity">vb</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beta_upright_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free">va</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> nonpos_upto <span class="free">va</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> order_zmset_exists_foundation<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear less_le_trans order.strict_trans1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* count_vec: nrec, the occupancy vector
   ('p ⇒ delta_vec): temp, the local change in the occupancy vector due to ops performed at given processor
   ('p ⇒ 'p ⇒ delta_vec list): msg, queue of updates from one processor to another
   ('p ⇒ delta_vec): glob, given processors (delayed) view of the occupancy vector *)</span>
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">=</span>
  c_records <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> delta_vec"</span></span>
  c_temp <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span>
  c_msg <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec list"</span></span>
  c_glob <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> computation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration stream"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_config</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_config</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="keyword1">{#}<span class="hidden">⇩</span><sub>z</sub></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p1</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_performop'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> count_vec <span class="main">⇒</span> <span class="tfree">'t</span> count_vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Δ</span> <span class="main">=</span> zmset_of <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> zmset_of <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> int <span class="main">(</span>count <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">≤</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>
    <span class="main">∧</span> upright <span class="bound">Δ</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="bound">Δ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_performop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_performop</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">(</span><span class="bound">c</span> <span class="main">::</span> <span class="tfree">'t</span> <span class="main">::</span> order count_vec<span class="main">)</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span><span class="tfree">'t</span> count_vec<span class="main">)</span><span class="main">.</span> next_performop' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_sendupd'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">γ</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">#}</span> <span class="keyword1">in</span>
      <span class="bound">γ</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="main">∧</span> upright <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> c_temp <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="bound">γ</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_sendupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_sendupd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">tt</span><span class="main">.</span> next_sendupd' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">tt</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_recvupd'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd'</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
   <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">[]</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">:=</span> c_glob <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">next_recvupd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_recvupd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> next_recvupd' <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>next_performop <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> next_sendupd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> next_recvupd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>holds init_config <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> alw next <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">NrecVacantUpto</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NrecVacantUpto</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vacant_upto <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="comment1">(* This is the main safety property (safe) *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobVacantUptoImpliesStickyNrec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is safe2 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeStickyNrecVacantUpto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeStickyNrecVacantUpto</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> NrecVacantUpto <span class="bound">c</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* This is inv1 *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobVacantUptoImpliesNrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobVacantUptoImpliesNrec</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">q</span><span class="main">.</span> vacant_upto <span class="main">(</span>c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⟶</span> vacant_upto <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvTempUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvTempUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> upright <span class="main">(</span>c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvTempUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempUpright_def init_config_def upright_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upright_obtain_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">a</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">a</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">a</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> upright_alt supported_strong_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command">using</span></span> order.strict_implies_order <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> upright_vec_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">v1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"upright <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"upright <span class="main">(</span><span class="free">v1</span> <span class="main">+</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">+</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> upr1<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="free">v1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> upr2<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="free">v2</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> zcnt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="var">?v0</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">va</span> <span class="skolem">vb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> zmultiset"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> upra<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="skolem">va</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> uprb<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="skolem">vb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> zcnt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">va</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> upra zcnt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="skolem">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="skolem">va</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> upright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> uprb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="main">(</span><span class="skolem">va</span><span class="main">+</span><span class="skolem">vb</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> zcount <span class="skolem">vb</span> <span class="bound">s</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_alt supported_strong_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> add_nonpos_neg less_imp_le order.strict_trans2 order.trans add_nonpos_nonpos<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> supported_strong_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> upr1 upr2 zcnt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supported_strong <span class="var">?v0</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> supported_strong_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">v1</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">v2</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_alt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvTempUpright <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_performop'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_sendupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> InvTempUpright_def next_recvupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_vec_add<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvTempUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alw_invar<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_def init_InvTempUpright<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop next_InvTempUpright spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IncomingInfo</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>sum_list <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> c_temp <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvIncomingInfoUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvIncomingInfoUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upright_0<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvIncomingInfoUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_0 upright_vec_add init_config_def InvIncomingInfoUpright_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> upright_vec_add next_performop'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_sendupd'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt k q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def Let_def InvIncomingInfoUpright_def IncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_Suc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> holds.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> init_InvIncomingInfoUpright next_InvIncomingInfoUpright spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">GlobalIncomingInfo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> configuration <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'t</span> delta_vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfo</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span> <span class="main">∈</span> UNIV<span class="main">.</span> IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* (GlobalIncomingInfo c 0 q q) sums up all info incoming at q *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">GlobalIncomingInfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">GlobalIncomingInfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalRecordCount</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalRecordCount</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> GlobalIncomingInfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span> <span class="main">+</span> c_glob <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"holds init_config <span class="free">s</span> <span class="main">⟹</span> holds InvGlobalRecordCount <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_if_distrib_add<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="free">b</span> <span class="main">+</span> <span class="free">Y</span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_add_class.add_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> sum.remove<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_if_distrib_add'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">=</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">X</span> <span class="free">b</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">X</span> <span class="bound">a</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_if_distrib_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">::</span> ab_group_add<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> sum_list <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> hd <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>tl <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span> hd <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_eq_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">b</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> next_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvGlobalRecordCount <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalRecordCount_def init_config_def GlobalIncomingInfo_def IncomingInfo_def next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c q r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> diff_conv_add_uminus<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_if_distrib_add<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def fun_upd_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q q'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_hd_tl<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_if_distrib_add'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> if_eq_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* This is inv2 in the short paper *)</span>
<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobalRecordCount<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar init_InvGlobalRecordCount next_InvGlobalRecordCount spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalIncomingInfoUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalIncomingInfoUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upright_sum_upright<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> upright <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> upright <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_0 upright_vec_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> InvIncomingInfoUpright_imp_InvGlobalIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span> <span class="main">⟹</span> holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvIncomingInfoUpright_def InvGlobalIncomingInfoUpright_def GlobalIncomingInfo_def upright_sum_upright<span class="main">)</span>

<span class="comment1">(* This is inv6 in the short paper *)</span>
<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobalIncomingInfoUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> InvIncomingInfoUpright_imp_InvGlobalIncomingInfoUpright alw_InvIncomingInfoUpright alw_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nrec_pos</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nrec_pos</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="main">(</span>c_records <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"holds init_config <span class="free">s</span> <span class="main">⟹</span> holds nrec_pos <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_config_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"holds nrec_pos <span class="free">s</span> <span class="main">⟹</span> next <span class="free">s</span> <span class="main">⟹</span> nxt <span class="main">(</span>holds nrec_pos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_diff_eq add.commute add_increasing<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_nrec_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds nrec_pos<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop alw_invar init_nrec_pos next_nrec_pos spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_performop_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_performop <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def vacant_upto_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c u r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_def supported_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> gr_implies_not_zero of_nat_le_0_iff order.strict_implies_order order_trans zero_less_iff_neq_zero<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_sendupd_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_sendupd <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_recvupd_vacant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> next_recvupd <span class="free">s</span> <span class="main">⟹</span> vacant_upto <span class="main">(</span>c_records <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_recvupd'_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_SafeStickyNrecVacantUpto_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"alw next <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyNrecVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next_def SafeStickyNrecVacantUpto_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop_vacant next_sendupd_vacant next_recvupd_vacant<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_SafeStickyNrecVacantUpto<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyNrecVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spec_imp_SafeStickyNrecVacantUpto_aux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvGlobVacantUptoImpliesNrec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvGlobalRecordCount <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds nrec_pos <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"holds InvGlobVacantUptoImpliesNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantUptoImpliesNrec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t q u
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> globvut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">sa</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> zcount <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="bound">sa</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uleqt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.not_eq_order_implies_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> globvut uleqt <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> InvGlobalIncomingInfoUpright_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>GlobalIncomingInfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.strict_iff_order upright_def supported_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="main">(</span>c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> InvGlobalRecordCount_def add.right_neutral dual_order.trans globvut holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> uleqt zcount_union<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> atLeastatMost_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobVacantUptoImpliesNrec<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> alw_iff_sdrop invs_imp_InvGlobVacantUptoImpliesNrec alw_InvGlobalIncomingInfoUpright alw_InvGlobalRecordCount alw_nrec_pos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe2_inv1_imp_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"SafeStickyNrecVacantUpto <span class="free">s</span> <span class="main">⟹</span> holds InvGlobVacantUptoImpliesNrec <span class="free">s</span> <span class="main">⟹</span> SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobVacantUptoImpliesNrec_def SafeStickyNrecVacantUpto_def SafeGlobVacantUptoImpliesStickyNrec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeGlobVacantUptoImpliesStickyNrec <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_iff_sdrop safe2_inv1_imp_safe spec_imp_SafeStickyNrecVacantUpto spec_imp_inv1<span class="main">)</span>



<span class="comment1">(* Second safety property from here on (glob stays vacant) *)</span>

<span class="keyword1"><span class="command">lemma</span></span> beta_upright_0<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">0</span> <span class="free">vb</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PositiveImplies</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PositiveImplies</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> zcount <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> zcount <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> betaupright_PositiveImplies<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="main">⟹</span> PositiveImplies <span class="free">va</span> <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="main">⟹</span> beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> beta_upright_def PositiveImplies_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> upright_obtain_support<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_less_zeroD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> betaupright_obtain_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
          <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">va</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> beta_upright_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> betaupright_upright_vut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"upright <span class="free">vb</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"vacant_upto <span class="main">(</span><span class="free">va</span> <span class="main">+</span> <span class="free">vb</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"vacant_upto <span class="free">va</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"nonpos_upto <span class="free">va</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> betaupright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> s x<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> upright_obtain_support<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">vb</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel2 order.trans order.strict_implies_order<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_less_same_cancel1 add_neg_neg order.order_iff_strict order.trans less_irrefl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms s x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.left_neutral dual_order.order_iff_strict dual_order.trans vacant_upto_def zcount_union<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> s x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> r <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vacant_upto_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> r add_cancel_right_left order.order_iff_strict order.trans le_less_linear less_add_same_cancel2 upright_obtain_support<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beta_upright_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"upright <span class="free">vb</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"upright <span class="free">vc</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="free">vb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"beta_upright <span class="free">va</span> <span class="main">(</span><span class="free">vb</span> <span class="main">+</span> <span class="free">vc</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">va</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">s</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="bound">s</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">u</span></span> <span class="main">≤</span> <span class="bound">s</span><span class="main">.</span> zcount <span class="free">va</span> <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> zcount <span class="free">va</span> <span class="skolem">t</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span>zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> nonpos_upto <span class="free">va</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> betaupright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">va</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assm x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹zcount <span class="free">vb</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vc</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> zcount <span class="free">vc</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> nonpos_upto <span class="free">vc</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> upright_obtain_support <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assm x y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">y</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_implies_order dual_order.strict_trans2 not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vb</span> <span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∧</span> zcount <span class="free">vb</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upright_def supported_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> x y z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zcount <span class="free">vb</span> <span class="skolem">z</span> <span class="main">+</span> zcount <span class="free">vc</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assm less_imp_le not_less order.strict_trans order.strict_trans1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zcount <span class="free">vc</span> <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> y z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dual_order.strict_implies_order not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> beta_upright_def zcount_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InfoAt</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InfoAt</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>c_msg <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvInfoAtBetaUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvInfoAtBetaUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_InvInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"init_config <span class="free">c</span> <span class="main">⟹</span> InvInfoAtBetaUpright <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_config_def InvInfoAtBetaUpright_def beta_upright_def IncomingInfo_def InfoAt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> next_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> next_performop next_sendupd next_recvupd stutter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_performop <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_sendupd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"next_recvupd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> next_InvInfoAtBetaUpright<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     a2<span class="main">:</span> <span class="quoted"><span class="quoted">"InvInfoAtBetaUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     a3<span class="main">:</span> <span class="quoted"><span class="quoted">"InvIncomingInfoUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     a4<span class="main">:</span> <span class="quoted"><span class="quoted">"InvTempUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"InvInfoAtBetaUpright <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> next_inv<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> next_performop
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_performop'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p c r k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> upright_Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="var">?Δ</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">,</span>
        c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iid<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="var">?Δ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def conf<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> iid
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> InvIncomingInfoUpright_def a3<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> upright_Δ<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> bu <span class="keyword1"><span class="command">unfolding</span></span> conf InfoAt_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="free">s</span><span class="main">⦇</span>c_records <span class="main">:=</span> c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">,</span>
        c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>zmset_of <span class="skolem">r</span> <span class="main">-</span> zmset_of <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> bu<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> IncomingInfo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conf<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bu<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> conf InfoAt_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> next_sendupd
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_sendupd'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p tt k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tt</span><span class="main">#}</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="var">?γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">-</span> <span class="var">?γ</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> a4 <span class="keyword1"><span class="command">have</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvTempUpright_def<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="main"><span class="main">(</span></span>c_msg <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> greater
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conf InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> beta_upright_0<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> equal
        <span class="keyword1"><span class="command">with</span></span> True conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="var">?γ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"PositiveImplies <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PositiveImplies_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> <span class="var">?γ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> equal True conf tu pi <span class="keyword1"><span class="command">have</span></span> butemp<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> betaupright_PositiveImplies<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">with</span></span> True equal conf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> c_temp <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> butemp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> less
        <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unch_ia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append InfoAt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> conf less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> buia unch_ia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">t</span> <span class="keyword1">∈#<span class="hidden">⇩</span><sub>z</sub></span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tt</span><span class="main">#}</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="var">?γ</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
              c_temp <span class="main">:=</span> <span class="main">(</span>c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> c_temp <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">-</span> <span class="var">?γ</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unchia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False conf <span class="keyword1"><span class="command">have</span></span> unchii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unchia unchii buia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> next_recvupd
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def Let_def InvInfoAtBetaUpright_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p q k' p' q'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> iisuc<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Suc IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True conf <span class="keyword1"><span class="command">have</span></span> iasuc<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_diff_conv nth_tl InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> InvInfoAtBetaUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> iisuc iasuc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> conf<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">⦇</span>c_msg <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> tl <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              c_glob <span class="main">:=</span> <span class="main">(</span>c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">q</span> <span class="main">:=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">+</span> hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> a2 <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvInfoAtBetaUpright_def<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> conf <span class="keyword1"><span class="command">have</span></span> unchii<span class="main">:</span> <span class="quoted"><span class="quoted">"IncomingInfo <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IncomingInfo_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> False conf <span class="keyword1"><span class="command">have</span></span> unchia<span class="main">:</span> <span class="quoted"><span class="quoted">"InfoAt <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">k'</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> InfoAt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unchii unchia buia <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvInfoAtBetaUpright_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvTempUpright<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvIncomingInfoUpright<span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> holds InvInfoAtBetaUpright <span class="free">s</span> <span class="main">⟹</span> alw next <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> next_InvInfoAtBetaUpright<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvTempUpright alw_InvIncomingInfoUpright alw_InvInfoAtBetaUpright_aux init_InvInfoAtBetaUpright spec_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InvGlobalInfoAtBetaUpright</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InvGlobalInfoAtBetaUpright</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_induct_select <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty select<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> finite <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">T</span> <span class="main">⊂</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">-</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>insert <span class="bound">s</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">∧</span> finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> empty select<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> *<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span>sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="bound">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct_select<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> T
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> psubset_imp_ex_mem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">z</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> invs_imp_InvGlobalInfoAtBetaUpright<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"holds InvInfoAtBetaUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds InvGlobalIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"holds InvIncomingInfoUpright <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"holds InvGlobalInfoAtBetaUpright <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> uii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvIncomingInfoUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ugii<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> upright <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvGlobalIncomingInfoUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> buia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>IncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> InvInfoAtBetaUpright_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uii ugii buia <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k p q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">UNIV</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> beta_upright <span class="main"><span class="main">(</span></span>InfoAt <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">v</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">p'</span></span><span class="main"><span class="main">.</span></span> IncomingInfo <span class="main"><span class="main">(</span></span>shd <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">p'</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword1"><span class="keyword1">then</span></span> Suc <span class="skolem"><span class="skolem">k</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">p'</span></span> <span class="skolem"><span class="skolem">q</span></span>"</span></span></span> <span class="quoted"><span class="quoted">upright</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_sum_upright<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' X
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> p' X
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> add.commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta_upright_add<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upright_sum_upright<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalInfoAtBetaUpright_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_InvGlobalInfoAtBetaUpright<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> alw_InvGlobalIncomingInfoUpright alw_InvIncomingInfoUpright alw_InvInfoAtBetaUpright alw_iff_sdrop invs_imp_InvGlobalInfoAtBetaUpright<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeStickyGlobVacantUpto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> finite<span class="main">,</span> <span class="tfree">'t</span> <span class="main">::</span> order<span class="main">)</span> computation <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeStickyGlobVacantUpto</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">q</span> <span class="bound">t</span> <span class="main">⟶</span> alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> GlobVacantUpto <span class="bound">c</span> <span class="bound">q</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gvut1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟹</span> next_performop <span class="free">s</span> <span class="main">⟹</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_performop'_def Let_def vacant_upto_def upright_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gvut2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟹</span> next_sendupd <span class="free">s</span> <span class="main">⟹</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_sendupd'_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gvut3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
   gvu<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   igvuin<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobVacantUptoImpliesNrec <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   igrc<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalRecordCount <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   igiiu<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalIncomingInfoUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   igiabu<span class="main">:</span> <span class="quoted"><span class="quoted">"InvGlobalInfoAtBetaUpright <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted">"next"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"next_recvupd <span class="free">s</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?GII1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">1</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?κ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> igiiu <span class="keyword1"><span class="command">have</span></span> uGII1<span class="main">:</span> <span class="quoted"><span class="quoted">"upright <span class="var">?GII1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobalIncomingInfoUpright_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> globk<span class="main">:</span> <span class="quoted"><span class="quoted">"c_glob <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="main">+</span> <span class="var">?κ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"c_msg <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sumGIIsk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?GII0</span> <span class="main">=</span> <span class="var">?GII1</span> <span class="main">+</span> <span class="var">?κ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum.remove <span class="dynamic"><span class="dynamic">ac_simps</span></span> neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword1"><span class="command">have</span></span> IA0k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?κ</span> <span class="main">=</span> InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InfoAt_def hd_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> igiabu nonempty <span class="keyword1"><span class="command">have</span></span> bukGII1<span class="main">:</span> <span class="quoted"><span class="quoted">"beta_upright <span class="var">?κ</span> <span class="var">?GII1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> igiabu
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"beta_upright <span class="main">(</span>InfoAt <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>GlobalIncomingInfo <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">1</span> <span class="skolem">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InvGlobalInfoAtBetaUpright_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IA0k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> igvuin gvu <span class="keyword1"><span class="command">have</span></span> nvu<span class="main">:</span> <span class="quoted"><span class="quoted">"NrecVacantUpto <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> InvGlobVacantUptoImpliesNrec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> igrc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_records <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="main">=</span> c_glob <span class="main">(</span>shd <span class="free">s</span><span class="main">)</span> <span class="free">q</span> <span class="main">+</span> <span class="var">?GII0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> GlobalIncomingInfo_def IncomingInfo_def InvGlobalRecordCount_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> gvu nvu <span class="keyword1"><span class="command">have</span></span> vuGII0<span class="main">:</span> <span class="quoted"><span class="quoted">"vacant_upto <span class="var">?GII0</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vacant_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bukGII1 uGII1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vacant_upto <span class="var">?κ</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> betaupright_upright_vut<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?κ</span></span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?GII1</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> vuGII0 add.commute sumGIIsk<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> gvu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> globk vacant_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> next_recvupd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_SafeStickyGlobVacantUpto_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobVacantUptoImpliesNrec <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalRecordCount <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalIncomingInfoUpright <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> InvGlobalInfoAtBetaUpright <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"alw next <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw SafeStickyGlobVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">unfolding</span></span> spec_def next_def SafeStickyGlobVacantUpto_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw.coinduct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> configuration stream"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobVacantUptoImpliesNrec<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_performop <span class="bound">s</span> <span class="main">∨</span> next_sendupd <span class="bound">s</span> <span class="main">∨</span> next_recvupd <span class="bound">s</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">s</span><span class="main">)</span> <span class="skolem">sb</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a6<span class="main">:</span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="skolem">sb</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_performop <span class="skolem">sb</span> <span class="main">∨</span> next_sendupd <span class="skolem">sb</span> <span class="main">∨</span> next_recvupd <span class="skolem">sb</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">=</span> shd <span class="skolem">sb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a6 a4 a3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> alwD gvut1 gvut2 gvut3 holds.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds InvGlobalRecordCount<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds InvGlobalIncomingInfoUpright<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span>holds InvGlobalInfoAtBetaUpright<span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> alw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> next_performop <span class="bound">s</span> <span class="main">∨</span> next_sendupd <span class="bound">s</span> <span class="main">∨</span> next_recvupd <span class="bound">s</span> <span class="main">∨</span> shd <span class="main">(</span>stl <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> shd <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span> <span class="main">∧</span> GlobVacantUpto <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">sb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a5 a4 a3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> spec_imp_SafeStickyGlobVacantUpto<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw SafeStickyGlobVacantUpto <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> spec_imp_SafeStickyGlobVacantUpto_aux<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_imp_inv1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalRecordCount<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalIncomingInfoUpright<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alw_InvGlobalInfoAtBetaUpright<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SafeGlobMono</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SafeGlobMono</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="bound">p</span> <span class="bound">t</span> <span class="main">⟶</span> GlobVacantUpto <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alw_SafeGlobMono<span class="main">:</span> <span class="quoted"><span class="quoted">"spec <span class="free">s</span> <span class="main">⟹</span> alw <span class="main">(</span>relates SafeGlobMono<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec_imp_SafeStickyGlobVacantUpto<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alw_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SafeStickyGlobVacantUpto_def SafeGlobMono_def relates_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>